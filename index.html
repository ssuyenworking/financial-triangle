<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ç†è²¡é‡‘ä¸‰è§’ï½œè²¡å‹™çµæ§‹æª¢è¦–</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- PDF: html2canvas + jsPDFï¼ˆé¿å… html2pdf ç©ºç™½ï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    body{font-family:system-ui,-apple-system,BlinkMacSystemFont;background:#f7f8fa;margin:0;padding:16px}
    h1{text-align:center;margin:0 0 6px}
    .subtitle{text-align:center;color:#555;margin:0}
    .desc{text-align:center;color:#888;font-size:14px;margin:8px 0 12px}
    .card{background:#fff;border-radius:12px;padding:16px;margin-bottom:16px;box-shadow:0 2px 8px rgba(0,0,0,.05)}
    label{display:block;margin-top:12px;font-weight:900}
    .sub-label{font-weight:700;margin-top:10px;color:#333}
    .hint{font-size:13px;color:#666;margin-top:8px;line-height:1.5;white-space:pre-line}
    input,select,textarea{width:100%;padding:10px;margin-top:6px;font-size:16px;box-sizing:border-box}
    textarea{min-height:72px;resize:vertical}
    button{width:100%;padding:14px;font-size:18px;border:none;border-radius:8px;margin-top:12px;cursor:pointer}
    .primary{background:#1f6fff;color:#fff}
    .cta{background:#e53935;color:#fff}
    .secondary{background:#4caf50;color:#fff}
    .reset{background:#9e9e9e;color:#fff}

    .result{font-size:18px;line-height:1.6;margin-top:12px;white-space:pre-line}
    .calc-box{margin-top:12px;padding:12px;border-radius:10px;background:#f2f6ff}
    .calc-title{font-weight:1000;margin-bottom:6px}
    .calc-row{display:flex;justify-content:space-between;gap:12px}
    .calc-row span{font-weight:1000}
    .status-chip{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:900;font-size:13px;background:#eee;color:#333;margin-top:8px}

    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:720px){ .grid-2{grid-template-columns:1fr} }

    .two-col{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:720px){ .two-col{grid-template-columns:1fr} }

    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:999}
    .modal-content{background:#fff;margin:8% auto;padding:18px;border-radius:12px;width:92%;max-width:520px}
    .option-btn{width:100%;padding:12px;border-radius:8px;border:1px solid #ccc;background:#f7f7f7;margin-top:8px;font-size:16px;cursor:pointer}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#f1f5ff;border:1px solid #d7e4ff;font-weight:900;margin-top:8px}

    #reportHeader{margin-bottom:10px;padding-bottom:10px;border-bottom:1px solid #eee}
    .report-title{font-size:20px;font-weight:1000;margin:0}
    .report-sub{color:#555;margin:4px 0 0}
    .report-meta{color:#777;font-size:13px;margin-top:8px;line-height:1.5}
    .small-note{font-size:13px;color:#777;margin-top:12px}

    .card-mini{background:#fafafa;border:1px solid #eee;border-radius:10px;padding:12px;margin-top:10px}
    .card-mini-title{font-weight:1000;margin:0 0 6px}
  </style>
</head>

<body>
  <h1>ç†è²¡é‡‘ä¸‰è§’</h1>
  <div class="subtitle">ç¾å ´å¡«å¯«ç‰ˆï¼šè²¡å‹™çµæ§‹æª¢è¦–</div>
  <div class="desc">å¡«å¯« â†’ åˆ†æ â†’ é¸ä½ æœ€é‡è¦– â†’ äºŒé¸ä¸€å»ºè­°ç‰ˆæœ¬ â†’ é¡¯ç¤ºã€Œè¨è«–å°å¡ã€ â†’ å¯ä¸‹è¼‰PDF</div>

  <!-- Input -->
  <div class="card">
    <label>å®¢æˆ¶ä»£ç¨±ï¼ˆé¸å¡«ï¼‰</label>
    <input type="text" id="clientAlias" placeholder="ä¾‹å¦‚ï¼šç‹å…ˆç”Ÿ / é™³å°å§ / Aå®¢ï¼ˆé¿å…å¡«èº«åˆ†è­‰ã€é›»è©±ç­‰å€‹è³‡ï¼‰" />

    <label>å¹´é½¡</label>
    <input type="number" id="clientAge" placeholder="ä¾‹å¦‚ï¼š28" inputmode="numeric"/>

    <label>æ”¶å…¥è¼¸å…¥æ–¹å¼</label>
    <select id="incomeType">
      <option value="month">æœˆæ”¶å…¥</option>
      <option value="year">å¹´æ”¶å…¥</option>
    </select>

    <label id="incomeLabel">æœˆæ”¶å…¥</label>
    <input type="number" id="incomeAmount" placeholder="ä¾‹å¦‚ï¼š45000" inputmode="numeric"/>

    <!-- Housing -->
    <label>å±…ä½ç‹€æ³ï¼ˆæˆ¿ç§Ÿ/æˆ¿è²¸ï¼‰</label>
    <div class="grid-2">
      <div>
        <div class="sub-label">ç›®å‰æ˜¯</div>
        <select id="housingType">
          <option value="rent">ç§Ÿå±‹ï¼ˆæˆ¿ç§Ÿï¼‰</option>
          <option value="mortgage">æœ‰æˆ¿è²¸</option>
          <option value="none">ç„¡ï¼ˆå®¶è£¡/å…¬å¸å®¿èˆ/å…æˆ¿ç§Ÿï¼‰</option>
        </select>
      </div>
      <div>
        <div class="sub-label">å‚™è¨»ï¼ˆé¸å¡«ï¼‰</div>
        <input type="text" id="housingNote" placeholder="ä¾‹å¦‚ï¼šè·Ÿå®¶äººåŒä½ / å…±åŒåˆ†æ”¤ / æˆ¿è²¸å‰© 18 å¹´â€¦" />
      </div>
    </div>

    <label>æ—¥å¸¸é–‹éŠ·ï¼ˆæ¯æœˆï¼Œè«‹é€é …å¡«å¯«ï¼‰</label>
    <div class="sub-label">æˆ¿ç§Ÿ/æˆ¿è²¸ï¼ˆä¾ä¸Šæ–¹ç‹€æ³å¡«é‡‘é¡ï¼‰</div>
    <input type="number" id="exp_housing" placeholder="0" inputmode="numeric"/>
    <div class="sub-label">è»Šè²¸</div>
    <input type="number" id="exp_carloan" placeholder="0" inputmode="numeric"/>
    <div class="sub-label">æ°´é›»ç“¦æ–¯/ç¶²è·¯æ‰‹æ©Ÿ</div>
    <input type="number" id="exp_utilities" placeholder="0" inputmode="numeric"/>
    <div class="sub-label">é¤é£²ï¼ˆå¤–é£Ÿ/è²·èœï¼‰</div>
    <input type="number" id="exp_food" placeholder="0" inputmode="numeric"/>
    <div class="sub-label">äº¤é€šï¼ˆé€šå‹¤/æ²¹éŒ¢/åœè»Šï¼‰</div>
    <input type="number" id="exp_transport" placeholder="0" inputmode="numeric"/>
    <div class="sub-label">æ•™è‚²/è‚²å…’ï¼ˆå­¸è²»/æ‰è—/ä¿æ¯ï¼‰</div>
    <input type="number" id="exp_kids" placeholder="0" inputmode="numeric"/>
    <div class="sub-label">å¨›æ¨‚/è³¼ç‰©/ç¤¾äº¤</div>
    <input type="number" id="exp_lifestyle" placeholder="0" inputmode="numeric"/>
    <div class="sub-label">å…¶ä»–å›ºå®šæ”¯å‡º</div>
    <input type="number" id="exp_other" placeholder="0" inputmode="numeric"/>

    <!-- Insurance money -->
    <label>ä¿éšªï¼ˆå®¢æˆ¶è‡ªè¡Œå¡«å¯«ï¼‰</label>
    <div class="grid-2">
      <div>
        <div class="sub-label">æ¯æœˆä¿è²»ï¼ˆå¤§ç´„å³å¯ï¼‰</div>
        <input type="number" id="insuranceMonthly" placeholder="ä¾‹å¦‚ï¼š2500" inputmode="numeric"/>
      </div>
      <div>
        <div class="sub-label">å‚™è¨»ï¼ˆé¸å¡«ï¼‰</div>
        <input type="text" id="insuranceNote" placeholder="ä¾‹å¦‚ï¼šåªæœ‰åœ˜ä¿ / ä¸»è¦æ˜¯é†«ç™‚ / å®¶äººå¹«è²·â€¦" />
      </div>
    </div>

    <!-- Cashflow -->
    <div class="calc-box">
      <div class="calc-title">ç³»çµ±è¨ˆç®—ï¼ˆç¾é‡‘æµï¼‰</div>
      <div class="calc-row"><div>æ¯æœˆæ—¥å¸¸é–‹éŠ·åˆè¨ˆï¼ˆå«ä¿è²»ï¼‰</div><div><span id="expenseTotal">0</span></div></div>
      <div class="calc-row" style="margin-top:6px;"><div>å¯æ”¯é…æ‰€å¾—ï¼ˆæœˆå‰©é¤˜ï¼‰</div><div><span id="remainingDisplay">0</span></div></div>
      <div class="hint">å¯æ”¯é…æ‰€å¾— = æœˆæ”¶å…¥ï¼ˆæ›ç®—ï¼‰ - æ—¥å¸¸é–‹éŠ·åˆè¨ˆï¼ˆå«ä¿è²»ï¼‰</div>
    </div>

    <!-- Emergency fund -->
    <label>ç·Šæ€¥é å‚™é‡‘ï¼ˆç›®å‰å·²å­˜çš„é‡‘é¡ï¼‰</label>
    <input type="number" id="emergencyFund" placeholder="ä¾‹å¦‚ï¼š120000" inputmode="numeric"/>

    <div class="calc-box" style="background:#f7f7ff;">
      <div class="calc-title">ç³»çµ±è¨ˆç®—ï¼ˆé å‚™é‡‘ï¼‰</div>
      <div class="calc-row"><div>é å‚™é‡‘å¯æ”¯æ’ï¼ˆæœˆï¼‰</div><div><span id="fundMonths">0</span></div></div>
      <div class="calc-row" style="margin-top:6px;"><div>ç‹€æ…‹æç¤º</div><div><span id="fundStatus" class="status-chip">å°šæœªè©•ä¼°</span></div></div>
      <div class="hint" id="fundHint">é å‚™é‡‘æœˆæ•¸ = ç·Šæ€¥é å‚™é‡‘ Ã· æ¯æœˆæ—¥å¸¸é–‹éŠ·åˆè¨ˆï¼ˆå«ä¿è²»ï¼‰</div>
    </div>

    <!-- Plan -->
    <label>3â€“5 å¹´è¨ˆç•«ï¼ˆè«‹è‡ªå·±å¡«ï¼‰</label>
    <div class="sub-label">è¨ˆç•«å…§å®¹ï¼ˆå¯å¤šé …ï¼‰</div>
    <textarea id="planText" placeholder="ä¾‹å¦‚ï¼šçµå©šã€è²·è»Šã€é€²ä¿®ã€å‡ºåœ‹ã€å‰µæ¥­ã€æˆ¿å±‹é ­æœŸæ¬¾..."></textarea>
    <div class="grid-2">
      <div>
        <div class="sub-label">ç›®æ¨™é‡‘é¡ï¼ˆä¼°è¨ˆå³å¯ï¼‰</div>
        <input type="number" id="planAmount" placeholder="ä¾‹å¦‚ï¼š300000" inputmode="numeric"/>
      </div>
      <div>
        <div class="sub-label">é è¨ˆå¹¾å¹´å®Œæˆï¼ˆ3â€“5 å¹´ï¼‰</div>
        <select id="planYears">
          <option value="0">å°šæœªç¢ºå®š</option>
          <option value="3">3 å¹´</option>
          <option value="4">4 å¹´</option>
          <option value="5">5 å¹´</option>
        </select>
      </div>
    </div>

    <!-- Investment -->
    <label>æŠ•è³‡ï¼ˆè‡ªè¡Œå¡«å¯«ï¼‰</label>
    <div class="grid-2">
      <div>
        <div class="sub-label">æ¯æœˆæŠ•è³‡é‡‘é¡ï¼ˆå¤§ç´„å³å¯ï¼‰</div>
        <input type="number" id="investmentMonthly" placeholder="ä¾‹å¦‚ï¼š3000" inputmode="numeric"/>
      </div>
      <div>
        <div class="sub-label">æŠ•è³‡æ–¹å¼ï¼ˆå¯å¤šé¸ï¼Œæˆ–å‚™è¨»ï¼‰</div>
        <input type="text" id="investmentMethods" placeholder="ä¾‹å¦‚ï¼šå®šæœŸå®šé¡ETF/åŸºé‡‘/è‚¡ç¥¨/å„²è“„/å…¶ä»–â€¦" />
      </div>
    </div>

    <!-- Protection detail -->
    <label>ä¿éšœæ¨¡çµ„æ¸…å–®ï¼ˆç”¨æ–¼ä¼°ç®—ä¿éšœå®Œæ•´åº¦ï¼‰</label>
    <div class="hint">è«‹å‹¾é¸ç›®å‰ã€Œç¢ºå®šæœ‰ã€çš„ä¿éšœé¡å‹ï¼ˆä¸ç¢ºå®šå°±å…ˆä¸è¦å‹¾ï¼‰ã€‚</div>

    <div class="two-col">
      <label style="font-weight:700;margin-top:8px;">
        <input type="checkbox" id="cov_medical"> é†«ç™‚ï¼ˆä½é™¢/æ‰‹è¡“/å¯¦æ”¯ï¼‰
      </label>
      <label style="font-weight:700;margin-top:8px;">
        <input type="checkbox" id="cov_accident"> æ„å¤–
      </label>
      <label style="font-weight:700;margin-top:8px;">
        <input type="checkbox" id="cov_cancer"> ç™Œç—‡
      </label>
      <label style="font-weight:700;margin-top:8px;">
        <input type="checkbox" id="cov_ci"> é‡å¤§å‚·ç—…
      </label>
      <label style="font-weight:700;margin-top:8px;">
        <input type="checkbox" id="cov_ltc"> é•·ç…§
      </label>
      <label style="font-weight:700;margin-top:8px;">
        <input type="checkbox" id="cov_life"> å£½éšªè²¬ä»»ï¼ˆå®¶åº­/æˆ¿è²¸ï¼‰
      </label>
    </div>

    <div class="calc-box" style="background:#f7fff7;">
      <div class="calc-title">ç³»çµ±è¨ˆç®—ï¼ˆä¿éšœå®Œæ•´åº¦ï¼‰</div>
      <div class="calc-row"><div>å·²å…·å‚™æ¨¡çµ„æ•¸</div><div><span id="covCount">0</span> / 6</div></div>
      <div class="calc-row" style="margin-top:6px;"><div>ä¿éšœå®Œæ•´åº¦</div><div><span id="covStatus" class="status-chip">å°šæœªè©•ä¼°</span></div></div>
      <div class="hint" id="covHint">å‹¾é¸å¾Œï¼Œç³»çµ±æœƒæç¤ºå„ªå…ˆè£œå¼·æ–¹å‘ã€‚</div>
    </div>

    <button class="primary" id="btnAnalyze" type="button">åˆ†ææˆ‘çš„ç†è²¡é‡‘ä¸‰è§’</button>
  </div>

  <!-- Report -->
  <div class="card" id="report">
    <div id="reportHeader">
      <p class="report-title">ç†è²¡é‡‘ä¸‰è§’ï½œè²¡å‹™çµæ§‹æª¢è¦–å ±å‘Š</p>
      <p class="report-sub">ç†è²¡ Ã— ä¿éšœ Ã— ç·Šæ€¥é å‚™é‡‘ï¼ˆåªçœ‹çµæ§‹ï¼Œä¸è«‡å ±é…¬ï¼‰</p>
      <div class="report-meta">
        <div>æ—¥æœŸï¼š<span id="reportDate"></span></div>
        <div>å®¢æˆ¶ä»£ç¨±ï¼š<span id="reportAlias">ï¼ˆæœªå¡«ï¼‰</span></div>
        <div>å¹´é½¡ï¼š<span id="reportAge">â€”</span></div>
      </div>
    </div>

    <div class="calc-box" style="background:#f7f7ff;">
      <div class="calc-title">ç¾æ³æ‘˜è¦ï¼ˆæ¯æœˆï¼‰</div>
      <div class="calc-row"><div>æœˆæ”¶å…¥ï¼ˆæ›ç®—ï¼‰</div><div><span id="reportIncome">0</span></div></div>
      <div class="calc-row" style="margin-top:6px;"><div>æ—¥å¸¸é–‹éŠ·åˆè¨ˆï¼ˆå«ä¿è²»ï¼‰</div><div><span id="reportExpense">0</span></div></div>
      <div class="calc-row" style="margin-top:6px;"><div>å¯æ”¯é…æ‰€å¾—ï¼ˆæœˆå‰©é¤˜ï¼‰</div><div><span id="reportRemaining">0</span></div></div>

      <div class="calc-row" style="margin-top:6px;"><div>æˆ¿ç§Ÿ/æˆ¿è²¸ç‹€æ³</div><div><span id="reportHousingType">â€”</span></div></div>
      <div class="calc-row" style="margin-top:6px;"><div>å‚™è¨»</div><div><span id="reportHousingNote">â€”</span></div></div>

      <div class="calc-row" style="margin-top:6px;"><div>ç·Šæ€¥é å‚™é‡‘</div><div><span id="reportFund">0</span></div></div>
      <div class="calc-row" style="margin-top:6px;"><div>é å‚™é‡‘å¯æ”¯æ’ï¼ˆæœˆï¼‰</div><div><span id="reportFundMonths">0</span></div></div>
      <div class="calc-row" style="margin-top:6px;"><div>é å‚™é‡‘ç‹€æ…‹</div><div><span id="reportFundStatus">å°šæœªè©•ä¼°</span></div></div>

      <div class="calc-row" style="margin-top:6px;"><div>æ¯æœˆä¿è²»ï¼ˆè‡ªè¡Œå¡«ï¼‰</div><div><span id="reportInsMonthly">0</span></div></div>
      <div class="calc-row" style="margin-top:6px;"><div>ä¿éšªå‚™è¨»</div><div><span id="reportInsNote">â€”</span></div></div>

      <div class="calc-row" style="margin-top:6px;"><div>æ¯æœˆæŠ•è³‡é‡‘é¡ï¼ˆè‡ªè¡Œå¡«ï¼‰</div><div><span id="reportInvMonthly">0</span></div></div>
      <div class="calc-row" style="margin-top:6px;"><div>æŠ•è³‡æ–¹å¼ï¼ˆè‡ªè¡Œå¡«ï¼‰</div><div><span id="reportInvMethods">â€”</span></div></div>
    </div>

    <!-- Coverage list in report -->
    <div class="calc-box" style="background:#f7fff7;">
      <div class="calc-title">ä¿éšœæ¸…å–®ï¼ˆæ¨¡çµ„å‹¾é¸ï¼‰</div>
      <div class="hint" style="margin-top:0;">
        å·²å…·å‚™ï¼š<span id="reportCovHas">ï¼ˆæœªå‹¾é¸ï¼‰</span><br/>
        æœªå…·å‚™ï¼š<span id="reportCovMissing">â€”</span><br/>
        ä¿éšœå®Œæ•´åº¦ï¼š<span id="reportCovStatus">å°šæœªè©•ä¼°</span>
      </div>
    </div>

    <div class="calc-box" style="background:#fff7f2;">
      <div class="calc-title">3â€“5 å¹´è¨ˆç•«</div>
      <div class="hint" style="margin-top:0;">
        å…§å®¹ï¼š<span id="reportPlanText">ï¼ˆæœªå¡«ï¼‰</span><br/>
        ç›®æ¨™é‡‘é¡ï¼š<span id="reportPlanAmount">0</span><br/>
        å¹´é™ï¼š<span id="reportPlanYears">å°šæœªç¢ºå®š</span>
      </div>
    </div>

    <div style="max-width:360px;margin:0 auto;">
      <canvas id="triangleChart" height="260"></canvas>
    </div>

    <div id="summary" class="result"></div>
    <div id="focusResult" class="result"></div>

    <div class="card-mini" id="dealBox" style="display:none;">
      <p class="card-mini-title">è¨è«–å°å¡ï¼ˆä¸‹ä¸€æ­¥æ€éº¼åšï¼‰</p>
      <div class="pill" id="dealPill">ç‰ˆæœ¬ï¼šâ€”</div>
      <div class="hint" id="dealScript" style="margin-top:10px;"></div>
    </div>

    <div id="nextStep" class="result" style="background:#f7f7ff;padding:12px;border-radius:10px;"></div>

    <p class="small-note">
      æœ¬å ±å‘Šåƒ…ç‚ºè²¡å‹™çµæ§‹æª¢è¦–ï¼Œä¸æ¶‰åŠæŠ•è³‡å ±é…¬ã€æ”¶ç›Šæ‰¿è«¾æˆ–ç‰¹å®šå•†å“æ¨è–¦ã€‚
      å¾ŒçºŒè¦åŠƒå°‡ä»¥é¢è«‡ç¢ºèªéœ€æ±‚èˆ‡å¯è² æ“”æ€§ç‚ºæº–ã€‚
    </p>
  </div>

  <button class="cta" id="btnOpenFocus" type="button">ä¸‹ä¸€æ­¥ï¼šé¸ä½ æœ€é‡è¦–çš„</button>
  <button class="secondary" id="btnPDF" type="button">ä¸‹è¼‰æœ¬æ¬¡åˆ†æå ±å‘Šï¼ˆPDFï¼‰</button>
  <button class="reset" id="btnReset" type="button">é‡è¨­ï¼ä¸‹ä¸€ä½å®¢æˆ¶</button>

  <!-- Focus Modal -->
  <div id="focusModal" class="modal">
    <div class="modal-content">
      <h3 style="margin:0 0 8px;">å¦‚æœåªèƒ½å…ˆé¡§å¥½ä¸€ä»¶äº‹ï¼Œä½ ç¾åœ¨æœ€åœ¨æ„å“ªä¸€å¡Šï¼Ÿ</h3>
      <button class="option-btn" type="button" data-focus="life">ç”Ÿæ´»ä¸ä¸­æ–·</button>
      <button class="option-btn" type="button" data-focus="family">ä¸æ‹–ç´¯å®¶äºº</button>
      <button class="option-btn" type="button" data-focus="future">æœªä¾†è¨ˆç•«ä¸è¢«æ‰“æ–·</button>
      <p id="focusTalk" style="margin-top:12px;line-height:1.6;"></p>
      <button class="primary" id="btnToDeal" type="button">ä¸‹ä¸€æ­¥ï¼šäºŒé¸ä¸€å»ºè­°ç‰ˆæœ¬</button>
      <button class="reset" id="btnCloseFocus" type="button">å…ˆä¸è¦</button>
    </div>
  </div>

  <!-- Deal Modal (A/B) -->
  <div id="dealModal" class="modal">
    <div class="modal-content">
      <h3 style="margin:0 0 8px;">äºŒé¸ä¸€ï¼šä½ å¸Œæœ›å…ˆæ¡ç”¨å“ªç¨®å»ºè­°ç‰ˆæœ¬ï¼Ÿ</h3>
      <div class="hint">å»ºè­°åšæ³•ï¼šå…ˆç”¨ A ä½è² æ“”å…ˆå¡ä½ï¼Œè®“è‡ªå·±ã€Œå…ˆæœ‰åŸºæœ¬é˜²è­·ã€ã€‚é¡˜æ„çš„è©±ï¼Œå†åš B å®Œæ•´åˆ°ä½ã€‚</div>

      <button class="option-btn" type="button" data-deal="A">
        Aï½œä½è² æ“”å…ˆå¡ä½ï¼ˆå…ˆæŠŠæœ€é‡è¦é‚£ä¸€å¡Šåšåˆ°ä½ï¼‰
        <div class="hint">æˆæœ¬è¼ƒä½ã€é€Ÿåº¦æœ€å¿«ï¼Œé©åˆå…ˆå»ºç«‹åŸºæœ¬é˜²è­·ã€‚</div>
      </button>

      <button class="option-btn" type="button" data-deal="B">
        Bï½œå®Œæ•´åˆ°ä½ï¼ˆä¸€æ¬¡è£œé½Šï¼‰
        <div class="hint">ä¸€æ¬¡æŠŠç¼ºå£è£œé½Šï¼Œçµæ§‹æ›´å®Œæ•´ã€å¾ŒçºŒæ›´çœå¿ƒã€‚</div>
      </button>

      <button class="primary" id="btnCloseDeal" type="button">å¥—ç”¨ä¸¦é—œé–‰</button>
    </div>
  </div>

<script>
  let chart=null;

  // Focus + Deal choice
  let currentFocus="life";   // life | family | future
  let currentDeal="A";       // A | B

  const n=v=>Number(v||0);
  const fmt=v=>Math.round(Number(v||0)).toLocaleString("zh-Hant-TW");

  function todayString(){
    const d=new Date();
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
  }

  function getAge(){ return Number(document.getElementById("clientAge").value || 0); }
  function ageStage(age){
    if(age<=0) return "";
    if(age<30) return "ï¼ˆèµ·æ­¥æœŸï¼‰";
    if(age<40) return "ï¼ˆç´¯ç©æœŸï¼‰";
    if(age<50) return "ï¼ˆè²¬ä»»é«˜å³°æœŸï¼‰";
    return "ï¼ˆç©©å®šï¼è½‰æ›æœŸï¼‰";
  }

  function getMonthlyIncome(){
    const t=document.getElementById("incomeType").value;
    const a=n(document.getElementById("incomeAmount").value);
    return t==="year"?a/12:a;
  }

  function getInsuranceMonthly(){ return n(document.getElementById("insuranceMonthly").value); }
  function getInvestmentMonthly(){ return n(document.getElementById("investmentMonthly").value); }

  function getExpenseTotal(){
    const ids=["exp_housing","exp_carloan","exp_utilities","exp_food","exp_transport","exp_kids","exp_lifestyle","exp_other"];
    const base=ids.reduce((s,id)=>s+n(document.getElementById(id).value),0);
    return base + getInsuranceMonthly(); // ä¿è²»ç®—å…¥é–‹éŠ·
  }

  function getEmergencyFund(){ return n(document.getElementById("emergencyFund").value); }
  function getFundMonths(){
    const exp=getExpenseTotal();
    const fund=getEmergencyFund();
    if(exp<=0) return 0;
    return fund/exp;
  }

  function getPlan(){
    return {
      text:(document.getElementById("planText").value||"").trim(),
      amount:n(document.getElementById("planAmount").value),
      years:n(document.getElementById("planYears").value)
    };
  }

  function housingTypeLabel(v){
    if(v==="rent") return "ç§Ÿå±‹ï¼ˆæˆ¿ç§Ÿï¼‰";
    if(v==="mortgage") return "æœ‰æˆ¿è²¸";
    return "ç„¡ï¼ˆå…æˆ¿ç§Ÿï¼‰";
  }

  // Single thresholds
  function fundStatus(fm){
    if(fm>=6) return {label:"å¾ˆç©© âœ…", msg:"é å‚™é‡‘ â‰¥6 å€‹æœˆï¼šç¾é‡‘æµé‡åˆ°è®Šå‹•ä¹Ÿæ¯”è¼ƒæ‰›å¾—ä½ã€‚", level:"good"};
    if(fm>=3) return {label:"è¶³å¤  ğŸ‘", msg:"é å‚™é‡‘ 3â€“6 å€‹æœˆï¼šåŸºæœ¬å®‰å…¨é‚Šéš›ä¸éŒ¯ã€‚", level:"good"};
    if(fm>=1) return {label:"å°šå¯ âš ï¸", msg:"é å‚™é‡‘ 1â€“3 å€‹æœˆï¼šå°šå¯ï¼Œä½†æ”¶å…¥ä¸­æ–·æ™‚å£“åŠ›æœƒä¸Šä¾†ã€‚", level:"warn"};
    return {label:"ä¸è¶³ â—", msg:"é å‚™é‡‘ <1 å€‹æœˆï¼šåä¸è¶³ï¼Œå»ºè­°å…ˆæ‹‰åˆ°è‡³å°‘ 1â€“3 å€‹æœˆã€‚", level:"bad"};
  }

  // Coverage detail
  function getCoverage(){
    const items = [
      {id:"cov_medical", label:"é†«ç™‚ï¼ˆä½é™¢/æ‰‹è¡“/å¯¦æ”¯ï¼‰"},
      {id:"cov_accident", label:"æ„å¤–"},
      {id:"cov_cancer", label:"ç™Œç—‡"},
      {id:"cov_ci", label:"é‡å¤§å‚·ç—…"},
      {id:"cov_ltc", label:"é•·ç…§"},
      {id:"cov_life", label:"å£½éšªè²¬ä»»ï¼ˆå®¶åº­/æˆ¿è²¸ï¼‰"}
    ];
    const has = items.filter(x => document.getElementById(x.id)?.checked);
    const missing = items.filter(x => !document.getElementById(x.id)?.checked);
    return {items, count: has.length, has, missing};
  }

  function coverageStatus(count){
    if(count>=5) return {label:"å¾ˆå®Œæ•´ âœ…", msg:"ä¿éšœæ¨¡çµ„å·²ç›¸å°å®Œæ•´ï¼Œæ¥ä¸‹ä¾†é‡é»æœƒå›åˆ°é å‚™é‡‘èˆ‡ç†è²¡ç¿’æ…£ã€‚"};
    if(count>=3) return {label:"ä¸­ç­‰ âš ï¸", msg:"å·²æœ‰éƒ¨åˆ†ä¿éšœï¼Œä½†ä»å¯èƒ½æœ‰æ˜é¡¯ç¼ºå£ï¼Œå»ºè­°å…ˆè£œæœ€å¸¸ç”¨çš„åŸºç¤æ¨¡çµ„ã€‚"};
    return {label:"åå°‘ â—", msg:"ä¿éšœæ¨¡çµ„åå°‘ï¼Œé‡åˆ°çªç™¼é¢¨éšªå®¹æ˜“æ‰“æ–·ç¾é‡‘æµï¼Œå»ºè­°å…ˆåšåŸºæœ¬é˜²è­·ã€‚"};
  }

  function updatePreviewAndReport(){
    document.getElementById("reportDate").innerText=todayString();
    const alias=(document.getElementById("clientAlias").value||"").trim();
    document.getElementById("reportAlias").innerText=alias?alias:"ï¼ˆæœªå¡«ï¼‰";

    const age=getAge();
    document.getElementById("reportAge").innerText = age ? `${age} æ­² ${ageStage(age)}` : "â€”";

    const income=getMonthlyIncome();
    const exp=getExpenseTotal();
    const remain=income-exp;

    document.getElementById("expenseTotal").innerText=fmt(exp);
    document.getElementById("remainingDisplay").innerText=fmt(remain);

    document.getElementById("reportIncome").innerText=fmt(income);
    document.getElementById("reportExpense").innerText=fmt(exp);
    document.getElementById("reportRemaining").innerText=fmt(remain);

    // housing
    const ht=document.getElementById("housingType").value;
    const hn=(document.getElementById("housingNote").value||"").trim();
    document.getElementById("reportHousingType").innerText=housingTypeLabel(ht);
    document.getElementById("reportHousingNote").innerText=hn?hn:"â€”";

    // fund
    const fund=getEmergencyFund();
    const fm=getFundMonths();
    const fmDisp=fm?fm.toFixed(1):"0";
    document.getElementById("fundMonths").innerText=fmDisp;
    document.getElementById("reportFund").innerText=fmt(fund);
    document.getElementById("reportFundMonths").innerText=fmDisp;

    const st=fundStatus(fm);
    document.getElementById("fundStatus").innerText=st.label;
    document.getElementById("fundHint").innerText="é å‚™é‡‘æœˆæ•¸ = ç·Šæ€¥é å‚™é‡‘ Ã· æ¯æœˆæ—¥å¸¸é–‹éŠ·åˆè¨ˆï¼ˆå«ä¿è²»ï¼‰\n"+st.msg;
    document.getElementById("reportFundStatus").innerText=st.label;

    // insurance & investment
    const insM=getInsuranceMonthly();
    const insN=(document.getElementById("insuranceNote").value||"").trim();
    document.getElementById("reportInsMonthly").innerText=fmt(insM);
    document.getElementById("reportInsNote").innerText=insN?insN:"â€”";

    const invM=getInvestmentMonthly();
    const invMeth=(document.getElementById("investmentMethods").value||"").trim();
    document.getElementById("reportInvMonthly").innerText=fmt(invM);
    document.getElementById("reportInvMethods").innerText=invMeth?invMeth:"â€”";

    // plan
    const plan=getPlan();
    document.getElementById("reportPlanText").innerText=plan.text?plan.text:"ï¼ˆæœªå¡«ï¼‰";
    document.getElementById("reportPlanAmount").innerText=fmt(plan.amount);
    document.getElementById("reportPlanYears").innerText=plan.years?`${plan.years} å¹´`:"å°šæœªç¢ºå®š";

    // coverage status + report list
    const cov = getCoverage();
    document.getElementById("covCount").innerText = cov.count;

    const cs = coverageStatus(cov.count);
    document.getElementById("covStatus").innerText = cs.label;

    const missingTop = cov.missing.map(x=>x.label).slice(0,3).join("ã€");
    document.getElementById("covHint").innerText =
      `${cs.msg}\nå„ªå…ˆè£œå¼·å»ºè­°ï¼š${missingTop || "ï¼ˆå·²å¾ˆå®Œæ•´ï¼‰"}`;

    const hasText = cov.has.length ? cov.has.map(x=>x.label).join("ã€") : "ï¼ˆæœªå‹¾é¸ï¼‰";
    const missingText = cov.missing.length ? cov.missing.map(x=>x.label).join("ã€") : "â€”";

    document.getElementById("reportCovHas").innerText = hasText;
    document.getElementById("reportCovMissing").innerText = missingText;
    document.getElementById("reportCovStatus").innerText = cs.label;
  }

  // -------- Radar axis scoring (Finance, Protection, Emergency Fund) ----------
  function scoreProtection(){ // ä¿éšœï¼šä¾æ¨¡çµ„æ•¸
    const c = getCoverage().count;
    if(c>=5) return 3;
    if(c>=3) return 2;
    return 1;
  }

  function scoreEmergencyFund(){ // ç·Šæ€¥é å‚™é‡‘
    const fm=getFundMonths();
    if(fm>=3) return 3;
    if(fm>=1) return 2;
    return 1;
  }

  function scoreFinance(){ // ç†è²¡ï¼ˆç¾é‡‘æµ + æŠ•è³‡ç¿’æ…£ï¼‰
    const remain=getMonthlyIncome()-getExpenseTotal();
    const inv=getInvestmentMonthly();
    if(remain<=0) return 1;
    if(inv>0) return 3;
    return 2;
  }

  // -------- Suggestions engine ----------
  function focusLabel(f){
    if(f==="family") return "ä¸æ‹–ç´¯å®¶äºº";
    if(f==="future") return "æœªä¾†è¨ˆç•«ä¸è¢«æ‰“æ–·";
    return "ç”Ÿæ´»ä¸ä¸­æ–·";
  }

  function focusExplain(f){
    const map={
      life:"ä½ é¸æ“‡çš„æ˜¯ï¼šç”Ÿæ´»ä¸ä¸­æ–·ï¼ˆå…ˆæŠŠçªç™¼äº‹ä»¶é€ æˆçš„ç¼ºå£è£œèµ·ä¾†ï¼Œç¢ºä¿ç¾é‡‘æµä¸ä¸­æ–·ï¼‰ã€‚",
      family:"ä½ é¸æ“‡çš„æ˜¯ï¼šä¸æ‹–ç´¯å®¶äººï¼ˆå…ˆæŠŠè²¬ä»»ç¼ºå£è£œèµ·ä¾†ï¼Œé–ä½å®¶äººçš„å®‰å…¨æ„Ÿï¼‰ã€‚",
      future:"ä½ é¸æ“‡çš„æ˜¯ï¼šæœªä¾†è¨ˆç•«ä¸è¢«æ‰“æ–·ï¼ˆå…ˆä¿ä½è¨ˆç•«ï¼Œå†ç”¨å›ºå®šé‡‘é¡æŠŠè¨ˆç•«åšå‡ºä¾†ï¼‰ã€‚"
    };
    return map[f] || map.life;
  }

  function dealLabel(d){ return d==="B" ? "Bï½œå®Œæ•´åˆ°ä½" : "Aï½œä½è² æ“”å…ˆå¡ä½"; }

  function renderNextStep(){
    const age=getAge();
    const fm=getFundMonths();
    const st=fundStatus(fm);
    const exp=getExpenseTotal();
    const plan=getPlan();
    const ht=document.getElementById("housingType").value;

    const income=getMonthlyIncome();
    const remain=income-exp;

    const cov = getCoverage();
    const missingList = cov.missing.map(x=>x.label);
    const covLine = `â€¢ ä¿éšœæ¨¡çµ„ï¼šå·²å…·å‚™ ${cov.count}/6ï¼ˆå»ºè­°å„ªå…ˆè£œï¼š${missingList.slice(0,3).join("ã€") || "å·²å¾ˆå®Œæ•´"}ï¼‰`;

    const ageLine = age ? `â€¢ å¹´é½¡ï¼š${age} æ­² ${ageStage(age)}ï¼ˆå»ºè­°æœƒä¾äººç”Ÿéšæ®µèª¿æ•´å„ªå…ˆé †åºï¼‰` : "";
    const fundLine = exp>0
      ? `â€¢ é å‚™é‡‘ç´„å¯æ’ ${fm?fm.toFixed(1):"0"} å€‹æœˆï¼ˆ${st.label}ï¼‰`
      : `â€¢ é å‚™é‡‘ç‹€æ…‹ï¼š${st.label}ï¼ˆå…ˆå¡«æ—¥å¸¸é–‹éŠ·æœƒæ›´æº–ï¼‰`;

    const planLine = plan.text
      ? `â€¢ 3â€“5 å¹´è¨ˆç•«ï¼š${plan.text}${plan.amount>0?`ï¼ˆç´„ ${fmt(plan.amount)}ï¼‰`:""}${plan.years>0?`ï¼Œç›®æ¨™ ${plan.years} å¹´ã€‚`:""}`
      : "â€¢ 3â€“5 å¹´è¨ˆç•«ï¼šå°šæœªå¡«ï¼ˆå»ºè­°å…ˆå¯«ç›®æ¨™å…§å®¹ï¼‹å¤§æ¦‚é‡‘é¡ï¼‰";

    const housingLine = (ht==="mortgage") ? "â€¢ æœ‰æˆ¿è²¸ï¼šè²¬ä»»é¢¨éšªå„ªå…ˆï¼ˆé†«ç™‚/æ„å¤–ï¼‹è²¬ä»»å‹ä¿éšœï¼‰" : "";
    const cashLine = `â€¢ å¯æ”¯é…æ‰€å¾—ï¼ˆæœˆå‰©é¤˜ï¼‰ï¼š${fmt(remain)}ï¼ˆå‰©é¤˜è¶Šç©©ï¼Œè¶Šå¥½åšé å‚™é‡‘èˆ‡ç†è²¡ï¼‰`;

    const base = [
      `ä½ æœ€åœ¨æ„ï¼š${focusLabel(currentFocus)}`,
      `å»ºè­°ç‰ˆæœ¬ï¼š${dealLabel(currentDeal)}`,
      "",
      "çµæ§‹æé†’ï¼š",
      ageLine,
      cashLine,
      covLine,
      fundLine,
      planLine,
      housingLine,
      ""
    ].filter(Boolean);

    const scripts = {
      life: {
        A: {
          steps:[
            "1) å…ˆæŠŠã€æœ€å®¹æ˜“æ‰“æ–·ç”Ÿæ´»ã€çš„ç¼ºå£è£œèµ·ä¾†ï¼ˆé†«ç™‚/æ„å¤–å„ªå…ˆï¼‰",
            "2) é å‚™é‡‘ä¸è¶³ï¼šå…ˆå¾ 1â€“3 å€‹æœˆé–‹å§‹ï¼Œæ…¢æ…¢æ‹‰åˆ° 3â€“6 å€‹æœˆ",
            "3) ç†è²¡ç”¨å°é¡å»ºç«‹ç¿’æ…£ï¼šæ¯æœˆå›ºå®šä¸€ç­†ï¼Œå…ˆåšåˆ°ã€ä¸ä¸­æ–·ã€"
          ],
          close:"è¨è«–å¼•å°ï¼šã€æˆ‘å€‘ä»Šå¤©å…ˆæŠŠã€Œä¸ä¸­æ–·ã€åšåˆ°ä½ï¼Œæˆ‘åšä¸€å€‹ã€Œä½è² æ“”ç‰ˆã€è®“ä½ å…ˆæœ‰åŸºæœ¬é˜²è­·ï¼Œä½ è¦ºå¾—å¯ä»¥å—ï¼Ÿã€"
        },
        B: {
          steps:[
            "1) é†«ç™‚ï¼‹æ„å¤–æ•´ç†åˆ°ä½ï¼šæŠŠå¸¸è¦‹çªç™¼é¢¨éšªç¼ºå£è£œé½Š",
            "2) é å‚™é‡‘æ‹‰åˆ° 3â€“6 å€‹æœˆï¼šè®“ç¾é‡‘æµæ›´ç©©",
            "3) ç†è²¡è¦åŠƒåˆ¶åº¦åŒ–ï¼šå›ºå®šæŠ•å…¥ï¼Œç©©å®šæ¨é€²è¨ˆç•«"
          ],
          close:"è¨è«–å¼•å°ï¼šã€æˆ‘å€‘ç›´æ¥åšã€Œå®Œæ•´åˆ°ä½ç‰ˆã€ï¼Œä½ å¾Œé¢æœƒçœå¾ˆå¤šå¿ƒã€‚æˆ‘åšä¸€å€‹æœˆè² æ“”åˆç†çš„é…ç½®ï¼Œä½ ç¢ºèªä¸€ä¸‹å°±å¯ä»¥ã€‚ã€"
        }
      },
      family: {
        A: {
          steps:[
            "1) å…ˆè£œã€è²¬ä»»ç¼ºå£ã€ï¼šè®“å®¶äººä¸æœƒå› çªç™¼äº‹ä»¶è¢«æ‹–ç´¯",
            "2) å†è£œé†«ç™‚è‡ªè²»ç¼ºå£ï¼šé¿å…é•·æœŸæ²»ç™‚æ‹–å®å®¶åº­ç¾é‡‘æµ",
            "3) é å‚™é‡‘å…ˆç©©ä½ï¼šå¾ 1â€“3 å€‹æœˆé–‹å§‹"
          ],
          close:"è¨è«–å¼•å°ï¼šã€ä½ é‡é»æ˜¯å®¶äººï¼Œæˆ‘å€‘å…ˆè£œã€Œè²¬ä»»ç¼ºå£ã€ï¼Œç”¨ä½ èƒ½æ¥å—çš„æœˆè² æ“”å…ˆåšåˆ°ä½ï¼Œå¥½å—ï¼Ÿã€"
        },
        B: {
          steps:[
            "1) è²¬ä»»ä¿éšœï¼‹é‡å¤§é¢¨éšªæ•´ç†å®Œæ•´ï¼šæŠŠå®¶åº­æœ€æ€•çš„ç¼ºå£è£œé½Š",
            "2) é†«ç™‚èˆ‡æ„å¤–ä¸€æ¬¡æ•´ç†ï¼šé™ä½é•·æœŸèŠ±è²»è¡æ“Š",
            "3) é å‚™é‡‘æ‹‰åˆ° 3â€“6 å€‹æœˆï¼šå®¶åº­å®‰å…¨é‚Šéš›æ›´å¤§"
          ],
          close:"è¨è«–å¼•å°ï¼šã€æˆ‘å€‘åšã€Œå®Œæ•´åˆ°ä½ç‰ˆã€ï¼ŒæŠŠä½ åœ¨æ„çš„ã€Œå®¶äººå®‰å…¨æ„Ÿã€ä¸€æ¬¡é¡§å¥½ã€‚æˆ‘åšå…©å€‹è² æ“”ç´šè·ä½ é¸ä¸€å€‹ã€‚ã€"
        }
      },
      future: {
        A: {
          steps:[
            "1) å…ˆç”¨é¢¨éšªç®¡ç†æŠŠè¨ˆç•«ä¿ä½ï¼šé†«ç™‚/æ„å¤–å…ˆåšåŸºæœ¬é˜²è­·",
            "2) æ¯æœˆå›ºå®šä¸€ç­†åšã€è¨ˆç•«åŸºé‡‘ã€ï¼šå…ˆæŠŠç›®æ¨™åšå‡ºä¾†",
            "3) ç†è²¡æ…¢æ…¢åŠ ï¼šç¾é‡‘æµç©©å†æŠŠæŠ•è³‡ç¿’æ…£æ”¾å¤§"
          ],
          close:"è¨è«–å¼•å°ï¼šã€ä½ é‡é»æ˜¯è¨ˆç•«ï¼Œæˆ‘å€‘å…ˆåšã€Œä½è² æ“”ç‰ˆã€æŠŠè¨ˆç•«ä¿ä½ï¼Œå†ç”¨å›ºå®šé‡‘é¡åšè¨ˆç•«åŸºé‡‘ï¼Œä½ è¦ºå¾—OKå—ï¼Ÿã€"
        },
        B: {
          steps:[
            "1) é¢¨éšªç®¡ç†å®Œæ•´åŒ–ï¼šè®“è¨ˆç•«ä¸æœƒè¢«ä¸€æ¬¡äº‹ä»¶æ‰“æ–·",
            "2) è¨ˆç•«åŸºé‡‘ï¼‹æŠ•è³‡ç¿’æ…£ä¸€èµ·å»ºç«‹ï¼šç”¨åˆ¶åº¦æŠŠç›®æ¨™æ¨é€²",
            "3) é å‚™é‡‘æ‹‰åˆ° 3â€“6 å€‹æœˆï¼šè®“è¨ˆç•«æ›´ä¸æ€•æ³¢å‹•"
          ],
          close:"è¨è«–å¼•å°ï¼šã€æˆ‘å€‘åšã€Œå®Œæ•´åˆ°ä½ç‰ˆã€ï¼Œä¸€æ¬¡æŠŠã€Œä¿ä½ï¼‹åšå‡ºä¾†ã€éƒ½é¡§åˆ°ã€‚æˆ‘åšå…©å€‹ç‰ˆæœ¬ä½ é¸ä¸€å€‹ã€‚ã€"
        }
      }
    };

    const s = (scripts[currentFocus] && scripts[currentFocus][currentDeal]) || scripts.life.A;

    const lines = [
      ...base,
      "ä¸‹ä¸€æ­¥å»ºè­°ï¼ˆä¾ä½ é¸çš„å„ªå…ˆé †åºï¼‰ï¼š",
      ...s.steps,
      "",
      s.close
    ];

    document.getElementById("nextStep").innerText = lines.join("\n");
  }

  function renderDealCard(){
    const dealBox=document.getElementById("dealBox");
    const dealPill=document.getElementById("dealPill");
    const dealScript=document.getElementById("dealScript");

    const oneLiner = `ä»Šå¤©å…ˆè¨è«–ï¼š${focusLabel(currentFocus)}ï¼ˆ${dealLabel(currentDeal)}ï¼‰`;
    const closeLine = document.getElementById("nextStep").innerText.split("\n").slice(-1)[0] || "";

    dealPill.innerText = `ç‰ˆæœ¬ï¼š${dealLabel(currentDeal)}ï½œé‡è¦–ï¼š${focusLabel(currentFocus)}`;
    dealScript.innerText = `${oneLiner}\n\n${closeLine}`;
    dealBox.style.display="block";
  }

  function analyze(){
    updatePreviewAndReport();

    const finance = scoreFinance();
    const protection = scoreProtection();
    const emergency = scoreEmergencyFund();

    if(chart) chart.destroy();
    chart=new Chart(document.getElementById("triangleChart"),{
      type:"radar",
      data:{
        labels:["ç†è²¡","ä¿éšœ","ç·Šæ€¥é å‚™é‡‘"],
        datasets:[{
          data:[finance, protection, emergency],
          backgroundColor:"rgba(31,111,255,0.2)",
          borderColor:"#1f6fff",
          borderWidth:2
        }]
      },
      options:{
        maintainAspectRatio:false,
        plugins:{legend:{display:false}},
        scales:{r:{min:0,max:3,ticks:{display:false}}}
      }
    });

    // Summary
    const summaryEl=document.getElementById("summary");
    const exp=getExpenseTotal();
    const income=getMonthlyIncome();
    const remain=income-exp;
    const fm=getFundMonths();
    const st=fundStatus(fm);
    const prot=scoreProtection();
    const cov=getCoverage().count;

    if(remain<=0){
      summaryEl.innerText="ç¾é‡‘æµç›®å‰åç·Šï¼Œå»ºè­°å…ˆæŠŠæ”¯å‡ºçµæ§‹èˆ‡ä¿è²»è² æ“”æ•´ç†æ¸…æ¥šï¼Œå†è«‡æŠ•è³‡èˆ‡é•·æœŸè¦åŠƒã€‚";
    }else if(st.level==="bad"){
      summaryEl.innerText="é å‚™é‡‘ä¸è¶³ï¼šå…ˆæŠŠç·Šæ€¥é å‚™é‡‘æ‹‰èµ·ä¾†ï¼Œé¿å…ä¸€æ¬¡äº‹ä»¶å°±è®“ç¾é‡‘æµå¤±æ§ã€‚";
    }else if(prot===1 || cov<=2){
      summaryEl.innerText="ä¿éšœæ¨¡çµ„åå°‘ï¼šå»ºè­°å…ˆè£œåŸºæœ¬é˜²è­·ï¼Œé¿å…çªç™¼é¢¨éšªæ‰“æ–·ç”Ÿæ´»èˆ‡è¨ˆç•«ã€‚";
    }else{
      summaryEl.innerText="ä½ çš„çµæ§‹æœ‰åŸºç¤ï¼šå¯ä»¥ç”¨ã€Œè£œé½Šä¿éšœç¼ºå£ï¼‹æ‹‰èµ·é å‚™é‡‘ï¼‹å»ºç«‹ç†è²¡ç¿’æ…£ã€ä¸‰æ­¥é©Ÿç©©å®šæ¨é€²ã€‚";
    }

    // Generate suggestion
    renderNextStep();

    // Clear discussion card until chosen
    document.getElementById("focusResult").innerText="";
    document.getElementById("focusTalk").innerText="";
    document.getElementById("dealBox").style.display="none";
    document.getElementById("dealPill").innerText="ç‰ˆæœ¬ï¼šâ€”";
    document.getElementById("dealScript").innerText="";
  }

  // ---------- Modals ----------
  function openFocus(){ document.getElementById("focusModal").style.display="block"; }
  function closeFocus(){ document.getElementById("focusModal").style.display="none"; }

  function openDeal(){ document.getElementById("dealModal").style.display="block"; }
  function closeDeal(){ document.getElementById("dealModal").style.display="none"; }

  function chooseFocus(type){
    currentFocus = type;

    const focusText = focusExplain(type);
    document.getElementById("focusTalk").innerText = focusText;
    document.getElementById("focusResult").innerText = focusText;

    renderNextStep();
  }

  function chooseDeal(deal){
    currentDeal = deal;
    renderNextStep();
    renderDealCard();
  }

  // ---------- PDF ----------
  async function downloadPDF(){
    const summaryText=(document.getElementById("summary").innerText||"").trim();
    if(!summaryText){
      alert("è«‹å…ˆæŒ‰ã€Œåˆ†ææˆ‘çš„ç†è²¡é‡‘ä¸‰è§’ã€ç”¢ç”Ÿå ±å‘Šå…§å®¹ï¼Œå†ä¸‹è¼‰ PDFã€‚");
      return;
    }

    updatePreviewAndReport();
    renderNextStep(); // ensure content up-to-date

    // Replace radar canvas with image to avoid missing in PDF
    const canvas=document.getElementById("triangleChart");
    const dataUrl=canvas.toDataURL("image/png",1.0);
    const img=document.createElement("img");
    img.src=dataUrl;
    img.style.width="100%";
    img.style.maxWidth="360px";
    img.style.display="block";
    img.style.margin="0 auto";

    const wrapper=canvas.parentElement;
    const backup=canvas.style.display;
    canvas.style.display="none";
    wrapper.appendChild(img);

    await new Promise(r=>requestAnimationFrame(r));

    const reportEl=document.getElementById("report");
    const canvasShot = await html2canvas(reportEl, {
      scale: 2,
      backgroundColor: "#ffffff",
      useCORS: true,
      scrollY: -window.scrollY
    });

    // restore
    img.remove();
    canvas.style.display=backup||"block";

    const imgData = canvasShot.toDataURL("image/jpeg", 0.95);
    const { jsPDF } = window.jspdf;

    const pdf = new jsPDF("p","mm","a4");
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();

    const imgWidth = pageWidth;
    const imgHeight = canvasShot.height * imgWidth / canvasShot.width;

    let heightLeft = imgHeight;
    let position = 0;

    pdf.addImage(imgData,"JPEG",0,position,imgWidth,imgHeight);
    heightLeft -= pageHeight;

    while(heightLeft > 0){
      position = heightLeft - imgHeight;
      pdf.addPage();
      pdf.addImage(imgData,"JPEG",0,position,imgWidth,imgHeight);
      heightLeft -= pageHeight;
    }

    const alias=(document.getElementById("clientAlias").value||"").trim();
    const filenameBase=alias?`ç†è²¡é‡‘ä¸‰è§’_åˆ†æå ±å‘Š_${alias}`:"ç†è²¡é‡‘ä¸‰è§’_åˆ†æå ±å‘Š";
    pdf.save(`${filenameBase}.pdf`);
  }

  // ---------- Reset ----------
  function resetAll(){
    document.getElementById("clientAlias").value="";
    document.getElementById("clientAge").value="";

    document.getElementById("incomeType").value="month";
    document.getElementById("incomeAmount").value="";

    document.getElementById("housingType").value="rent";
    document.getElementById("housingNote").value="";

    ["exp_housing","exp_carloan","exp_utilities","exp_food","exp_transport","exp_kids","exp_lifestyle","exp_other"].forEach(id=>{
      document.getElementById(id).value="";
    });

    document.getElementById("insuranceMonthly").value="";
    document.getElementById("insuranceNote").value="";

    document.getElementById("emergencyFund").value="";
    document.getElementById("planText").value="";
    document.getElementById("planAmount").value="";
    document.getElementById("planYears").value="0";

    document.getElementById("investmentMonthly").value="";
    document.getElementById("investmentMethods").value="";

    // coverage checks
    ["cov_medical","cov_accident","cov_cancer","cov_ci","cov_ltc","cov_life"].forEach(id=>{
      const el=document.getElementById(id);
      if(el) el.checked=false;
    });

    document.getElementById("summary").innerText="";
    document.getElementById("focusResult").innerText="";
    document.getElementById("focusTalk").innerText="";
    document.getElementById("nextStep").innerText="";

    document.getElementById("dealBox").style.display="none";
    document.getElementById("dealPill").innerText="ç‰ˆæœ¬ï¼šâ€”";
    document.getElementById("dealScript").innerText="";

    currentFocus="life";
    currentDeal="A";
    closeFocus();
    closeDeal();

    if(chart){ chart.destroy(); chart=null; }

    document.getElementById("incomeLabel").innerText="æœˆæ”¶å…¥";
    document.getElementById("reportDate").innerText=todayString();
    updatePreviewAndReport();
    document.getElementById("incomeAmount").focus();
  }

  // ---------- Wire up ----------
  document.addEventListener("DOMContentLoaded",()=>{
    document.getElementById("reportDate").innerText=todayString();

    const incomeTypeEl=document.getElementById("incomeType");
    const incomeLabelEl=document.getElementById("incomeLabel");
    function syncIncomeLabel(){
      incomeLabelEl.innerText=incomeTypeEl.value==="year"?"å¹´æ”¶å…¥":"æœˆæ”¶å…¥";
      updatePreviewAndReport();
    }
    incomeTypeEl.addEventListener("change",syncIncomeLabel);

    const watchIds=[
      "clientAlias","clientAge","incomeAmount","housingType","housingNote",
      "exp_housing","exp_carloan","exp_utilities","exp_food","exp_transport","exp_kids","exp_lifestyle","exp_other",
      "insuranceMonthly","insuranceNote",
      "emergencyFund","planText","planAmount","planYears",
      "investmentMonthly","investmentMethods"
    ];
    watchIds.forEach(id=>{
      const el=document.getElementById(id);
      if(!el) return;
      el.addEventListener(el.tagName==="SELECT" ? "change" : "input", updatePreviewAndReport);
    });

    // checkboxes realtime
    ["cov_medical","cov_accident","cov_cancer","cov_ci","cov_ltc","cov_life"].forEach(id=>{
      const el=document.getElementById(id);
      if(!el) return;
      el.addEventListener("change", updatePreviewAndReport);
    });

    document.getElementById("btnAnalyze").addEventListener("click",analyze);

    document.getElementById("btnOpenFocus").addEventListener("click",()=>{
      const summaryText=(document.getElementById("summary").innerText||"").trim();
      if(!summaryText){
        alert("è«‹å…ˆæŒ‰ã€Œåˆ†ææˆ‘çš„ç†è²¡é‡‘ä¸‰è§’ã€ç”¢ç”Ÿå ±å‘Šå…§å®¹ï¼Œå†é€²å…¥ä¸‹ä¸€æ­¥ã€‚");
        return;
      }
      openFocus();
    });

    document.getElementById("btnToDeal").addEventListener("click",()=>{
      if(!document.getElementById("focusTalk").innerText.trim()){
        chooseFocus("life");
      }
      closeFocus();
      openDeal();
    });

    document.getElementById("btnCloseFocus").addEventListener("click",closeFocus);

    document.querySelectorAll("#focusModal .option-btn[data-focus]").forEach(btn=>{
      btn.addEventListener("click",()=>chooseFocus(btn.dataset.focus));
    });

    document.querySelectorAll("#dealModal .option-btn[data-deal]").forEach(btn=>{
      btn.addEventListener("click",()=>chooseDeal(btn.dataset.deal));
    });

    document.getElementById("btnCloseDeal").addEventListener("click",()=>{
      closeDeal();
      renderNextStep();
      renderDealCard();
    });

    document.getElementById("btnPDF").addEventListener("click",downloadPDF);
    document.getElementById("btnReset").addEventListener("click",resetAll);

    syncIncomeLabel();
    updatePreviewAndReport();
    renderNextStep();
  });

  // close modals when click outside
  window.addEventListener("click",(e)=>{
    const fm=document.getElementById("focusModal");
    const dm=document.getElementById("dealModal");
    if(e.target===fm) closeFocus();
    if(e.target===dm) closeDeal();
  });
</script>
</body>
</html>