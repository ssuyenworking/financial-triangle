<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ç†è²¡é‡‘ä¸‰è§’ï½œè²¡å‹™çµæ§‹æª¢è¦–</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    body{font-family:system-ui,-apple-system,BlinkMacSystemFont;background:#f7f8fa;margin:0;padding:16px}
    h1{text-align:center;margin:0 0 6px}
    .subtitle{text-align:center;color:#555;margin:0}
    .desc{text-align:center;color:#888;font-size:14px;margin:8px 0 12px}
    .card{background:#fff;border-radius:12px;padding:16px;margin-bottom:16px;box-shadow:0 2px 8px rgba(0,0,0,.05)}
    label{display:block;margin-top:12px;font-weight:900}
    .sub-label{font-weight:700;margin-top:10px;color:#333}
    .hint{font-size:13px;color:#666;margin-top:8px;line-height:1.5;white-space:pre-line}
    input,select,textarea{width:100%;padding:10px;margin-top:6px;font-size:16px;box-sizing:border-box}
    textarea{min-height:72px;resize:vertical}
    button{width:100%;padding:14px;font-size:18px;border:none;border-radius:8px;margin-top:12px;cursor:pointer}
    .primary{background:#1f6fff;color:#fff}
    .cta{background:#e53935;color:#fff}
    .secondary{background:#4caf50;color:#fff}
    .reset{background:#9e9e9e;color:#fff}
    .switch-group{display:flex;gap:8px;margin-top:8px}
    .switch-btn{flex:1;padding:12px;font-size:16px;border-radius:8px;border:1px solid #ccc;background:#f2f2f2;cursor:pointer}
    .switch-btn.active{background:#1f6fff;color:#fff;border-color:#1f6fff}
    .result{font-size:18px;line-height:1.6;margin-top:12px;white-space:pre-line}
    .calc-box{margin-top:12px;padding:12px;border-radius:10px;background:#f2f6ff}
    .calc-title{font-weight:1000;margin-bottom:6px}
    .calc-row{display:flex;justify-content:space-between;gap:12px}
    .calc-row span{font-weight:1000}
    .status-chip{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:900;font-size:13px;background:#eee;color:#333;margin-top:8px}
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:999}
    .modal-content{background:#fff;margin:10% auto;padding:18px;border-radius:12px;width:92%;max-width:460px}
    .option-btn{width:100%;padding:12px;border-radius:8px;border:1px solid #ccc;background:#f7f7f7;margin-top:8px;font-size:16px;cursor:pointer}
    #reportHeader{margin-bottom:10px;padding-bottom:10px;border-bottom:1px solid #eee}
    .report-title{font-size:20px;font-weight:1000;margin:0}
    .report-sub{color:#555;margin:4px 0 0}
    .report-meta{color:#777;font-size:13px;margin-top:8px;line-height:1.5}
    .small-note{font-size:13px;color:#777;margin-top:12px}
  </style>
</head>

<body>
  <h1>ç†è²¡é‡‘ä¸‰è§’</h1>
  <div class="subtitle">å¿«é€Ÿçœ‹æ‡‚ä½ çš„è²¡å‹™çµæ§‹</div>
  <div class="desc">ä¸æ˜¯æŠ•è³‡æ¨¡å‹ï¼Œåªç”¨ä¾†æª¢è¦–çµæ§‹æ˜¯å¦å®‰å…¨ï¼ˆç¾å ´å¡«ã€ç¾å ´è§£è®€ã€ç¾å ´æˆäº¤ï¼‰</div>

  <div class="card">
    <label>ä½ ç›®å‰çš„ç‹€æ…‹</label>
    <div class="switch-group">
      <button id="btnStudent" class="switch-btn active" type="button">ğŸ“ å­¸ç”Ÿ / å‰›å‡ºç¤¾æœƒ</button>
      <button id="btnWorker" class="switch-btn" type="button">ğŸ’¼ ä¸€èˆ¬ä¸Šç­æ—</button>
    </div>

    <label>å®¢æˆ¶ä»£ç¨±ï¼ˆé¸å¡«ï¼Œä¸å¡«ä¹Ÿå¯è¼¸å‡ºPDFï¼‰</label>
    <input type="text" id="clientAlias" placeholder="ä¾‹å¦‚ï¼šç‹å…ˆç”Ÿ / å°æ½” / Aå®¢ï¼ˆé¿å…å¡«èº«åˆ†è­‰ã€é›»è©±ç­‰å€‹è³‡ï¼‰" />

    <label>æ”¶å…¥è¼¸å…¥æ–¹å¼</label>
    <select id="incomeType">
      <option value="month">æœˆæ”¶å…¥</option>
      <option value="year">å¹´æ”¶å…¥</option>
    </select>

    <label id="incomeLabel">æœˆæ”¶å…¥</label>
    <input type="number" id="incomeAmount" placeholder="ä¾‹å¦‚ï¼š45000" inputmode="numeric"/>

    <label>æ—¥å¸¸é–‹éŠ·ï¼ˆæ¯æœˆï¼Œè«‹é€é …å¡«å¯«ï¼‰</label>
    <div class="sub-label">æˆ¿ç§Ÿ/æˆ¿è²¸</div><input type="number" id="exp_housing" placeholder="0" inputmode="numeric"/>
    <div class="sub-label">è»Šè²¸</div><input type="number" id="exp_carloan" placeholder="0" inputmode="numeric"/>
    <div class="sub-label">æ°´é›»ç“¦æ–¯/ç¶²è·¯æ‰‹æ©Ÿ</div><input type="number" id="exp_utilities" placeholder="0" inputmode="numeric"/>
    <div class="sub-label">é¤é£²ï¼ˆå¤–é£Ÿ/è²·èœï¼‰</div><input type="number" id="exp_food" placeholder="0" inputmode="numeric"/>
    <div class="sub-label">äº¤é€šï¼ˆé€šå‹¤/æ²¹éŒ¢/åœè»Šï¼‰</div><input type="number" id="exp_transport" placeholder="0" inputmode="numeric"/>
    <div class="sub-label">æ•™è‚²/è‚²å…’ï¼ˆå­¸è²»/æ‰è—/ä¿æ¯ï¼‰</div><input type="number" id="exp_kids" placeholder="0" inputmode="numeric"/>
    <div class="sub-label">ä¿è²»ï¼ˆç¾æœ‰ä¿å–®æ¯æœˆä¿è²»ï¼‰</div><input type="number" id="exp_insurance" placeholder="0" inputmode="numeric"/>
    <div class="sub-label">å¨›æ¨‚/è³¼ç‰©/ç¤¾äº¤</div><input type="number" id="exp_lifestyle" placeholder="0" inputmode="numeric"/>
    <div class="sub-label">å…¶ä»–å›ºå®šæ”¯å‡º</div><input type="number" id="exp_other" placeholder="0" inputmode="numeric"/>

    <div class="calc-box">
      <div class="calc-title">ç³»çµ±è¨ˆç®—ï¼ˆç¾é‡‘æµï¼‰</div>
      <div class="calc-row"><div>æ¯æœˆæ—¥å¸¸é–‹éŠ·åˆè¨ˆ</div><div><span id="expenseTotal">0</span></div></div>
      <div class="calc-row" style="margin-top:6px;"><div>å¯æ”¯é…æ‰€å¾—ï¼ˆæœˆå‰©é¤˜ï¼‰</div><div><span id="remainingDisplay">0</span></div></div>
      <div class="hint">å¯æ”¯é…æ‰€å¾— = æœˆæ”¶å…¥ï¼ˆæ›ç®—ï¼‰ - æ—¥å¸¸é–‹éŠ·åˆè¨ˆ</div>
    </div>

    <label>ç·Šæ€¥é å‚™é‡‘ï¼ˆç›®å‰å·²å­˜çš„é‡‘é¡ï¼‰</label>
    <input type="number" id="emergencyFund" placeholder="ä¾‹å¦‚ï¼š120000" inputmode="numeric"/>

    <div class="calc-box" style="background:#f7f7ff;">
      <div class="calc-title">ç³»çµ±è¨ˆç®—ï¼ˆé å‚™é‡‘ï¼‰</div>
      <div class="calc-row"><div>é å‚™é‡‘å¯æ”¯æ’ï¼ˆæœˆï¼‰</div><div><span id="fundMonths">0</span></div></div>
      <div class="calc-row" style="margin-top:6px;"><div>ç‹€æ…‹æç¤º</div><div><span id="fundStatus" class="status-chip">å°šæœªè©•ä¼°</span></div></div>
      <div class="hint" id="fundHint">é å‚™é‡‘æœˆæ•¸ = ç·Šæ€¥é å‚™é‡‘ Ã· æ¯æœˆæ—¥å¸¸é–‹éŠ·åˆè¨ˆ</div>
    </div>

    <label>3â€“5 å¹´è¨ˆç•«ï¼ˆè«‹å®¢æˆ¶è‡ªå·±å¡«ï¼‰</label>
    <div class="sub-label">è¨ˆç•«å…§å®¹ï¼ˆå¯å¤šé …ï¼‰</div>
    <textarea id="planText" placeholder="ä¾‹å¦‚ï¼šçµå©šã€è²·è»Šã€é€²ä¿®ã€å‡ºåœ‹ã€å‰µæ¥­ã€æˆ¿å±‹é ­æœŸæ¬¾..."></textarea>
    <div class="sub-label">ç›®æ¨™é‡‘é¡ï¼ˆä¼°è¨ˆå³å¯ï¼‰</div>
    <input type="number" id="planAmount" placeholder="ä¾‹å¦‚ï¼š300000" inputmode="numeric"/>
    <div class="sub-label">é è¨ˆå¹¾å¹´å®Œæˆï¼ˆ3â€“5 å¹´ï¼‰</div>
    <select id="planYears">
      <option value="0">å°šæœªç¢ºå®š</option>
      <option value="3">3 å¹´</option>
      <option value="4">4 å¹´</option>
      <option value="5">5 å¹´</option>
    </select>

    <label>æ˜¯å¦æœ‰æŠ•è³‡</label>
    <select id="investment"><option value="none">æ²’æœ‰</option><option value="yes">æœ‰</option></select>

    <label>ä¿éšªç‹€æ…‹</label>
    <select id="insurance"><option value="none">æ²’æœ‰</option><option value="partial">ä¸å®Œæ•´</option><option value="basic">åŸºæœ¬ä¿éšœå®Œæ•´</option></select>

    <button class="primary" id="btnAnalyze" type="button">åˆ†ææˆ‘çš„ç†è²¡é‡‘ä¸‰è§’</button>
  </div>

  <div class="card" id="report">
    <div id="reportHeader">
      <p class="report-title">ç†è²¡é‡‘ä¸‰è§’ï½œè²¡å‹™çµæ§‹æª¢è¦–å ±å‘Š</p>
      <p class="report-sub">å®‰å…¨ Ã— æº–å‚™ Ã— æˆé•·ï¼ˆåªçœ‹çµæ§‹ï¼Œä¸è«‡å ±é…¬ï¼‰</p>
      <div class="report-meta">
        <div>æ—¥æœŸï¼š<span id="reportDate"></span></div>
        <div>å®¢æˆ¶ä»£ç¨±ï¼š<span id="reportAlias">ï¼ˆæœªå¡«ï¼‰</span></div>
      </div>
    </div>

    <div class="calc-box" style="background:#f7f7ff;">
      <div class="calc-title">ç¾æ³æ‘˜è¦ï¼ˆæ¯æœˆï¼‰</div>
      <div class="calc-row"><div>æœˆæ”¶å…¥ï¼ˆæ›ç®—ï¼‰</div><div><span id="reportIncome">0</span></div></div>
      <div class="calc-row" style="margin-top:6px;"><div>æ—¥å¸¸é–‹éŠ·åˆè¨ˆ</div><div><span id="reportExpense">0</span></div></div>
      <div class="calc-row" style="margin-top:6px;"><div>å¯æ”¯é…æ‰€å¾—ï¼ˆæœˆå‰©é¤˜ï¼‰</div><div><span id="reportRemaining">0</span></div></div>
      <div class="calc-row" style="margin-top:6px;"><div>ç·Šæ€¥é å‚™é‡‘</div><div><span id="reportFund">0</span></div></div>
      <div class="calc-row" style="margin-top:6px;"><div>é å‚™é‡‘å¯æ”¯æ’ï¼ˆæœˆï¼‰</div><div><span id="reportFundMonths">0</span></div></div>
      <div class="calc-row" style="margin-top:6px;"><div>é å‚™é‡‘ç‹€æ…‹</div><div><span id="reportFundStatus">å°šæœªè©•ä¼°</span></div></div>
    </div>

    <div class="calc-box" style="background:#fff7f2;">
      <div class="calc-title">3â€“5 å¹´è¨ˆç•«</div>
      <div class="hint" style="margin-top:0;">
        å…§å®¹ï¼š<span id="reportPlanText">ï¼ˆæœªå¡«ï¼‰</span><br/>
        ç›®æ¨™é‡‘é¡ï¼š<span id="reportPlanAmount">0</span><br/>
        å¹´é™ï¼š<span id="reportPlanYears">å°šæœªç¢ºå®š</span>
      </div>
    </div>

    <div style="max-width:360px;margin:0 auto;">
      <canvas id="triangleChart" height="260"></canvas>
    </div>

    <div id="summary" class="result"></div>
    <div id="focusResult" class="result"></div>
    <div id="nextStep" class="result" style="background:#f7f7ff;padding:12px;border-radius:10px;"></div>

    <p class="small-note">
      æœ¬å ±å‘Šåƒ…ç‚ºè²¡å‹™çµæ§‹æª¢è¦–ï¼Œä¸æ¶‰åŠå•†å“åç¨±ã€é‡‘é¡ã€ä¿é¡ã€æŠ•è³‡å ±é…¬æˆ–ä»»ä½•æ”¶ç›Šæ‰¿è«¾ã€‚
      è‹¥éœ€é€²ä¸€æ­¥æ–¹æ¡ˆï¼Œå°‡ä»¥é¢è«‡ç¢ºèªéœ€æ±‚å¾Œå¦è¡Œèªªæ˜ã€‚
    </p>
  </div>

  <button class="cta" id="btnOpenModal" type="button">é–‹å§‹åŸºæœ¬ä¿éšœé…ç½®èªªæ˜</button>
  <button class="secondary" id="btnPDF" type="button">ä¸‹è¼‰æœ¬æ¬¡åˆ†æå ±å‘Šï¼ˆPDFï¼‰</button>
  <button class="reset" id="btnReset" type="button">é‡è¨­ï¼ä¸‹ä¸€ä½å®¢æˆ¶</button>

  <div id="modal" class="modal">
    <div class="modal-content">
      <h3 style="margin:0 0 8px;">å¦‚æœåªèƒ½å…ˆé¡§å¥½ä¸€ä»¶äº‹ï¼Œä½ ç¾åœ¨æœ€åœ¨æ„å“ªä¸€å¡Šï¼Ÿ</h3>
      <button class="option-btn" type="button" data-focus="life">ç”Ÿæ´»ä¸ä¸­æ–·</button>
      <button class="option-btn" type="button" data-focus="family">ä¸æ‹–ç´¯å®¶äºº</button>
      <button class="option-btn" type="button" data-focus="future">æœªä¾†è¨ˆç•«ä¸è¢«æ‰“æ–·</button>
      <p id="talkCard" style="margin-top:12px;line-height:1.6;"></p>
      <button class="primary" id="btnCloseModal" type="button">äº†è§£ï¼Œé–‹å§‹èªªæ˜</button>
    </div>
  </div>

<script>
  let chart=null;
  let userType="student";
  let focusText="";

  const n=v=>Number(v||0);
  const fmt=v=>Math.round(Number(v||0)).toLocaleString("zh-Hant-TW");
  function todayString(){
    const d=new Date();
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
  }
  function getMonthlyIncome(){
    const t=document.getElementById("incomeType").value;
    const a=n(document.getElementById("incomeAmount").value);
    return t==="year"?a/12:a;
  }
  function getExpenseTotal(){
    const ids=["exp_housing","exp_carloan","exp_utilities","exp_food","exp_transport","exp_kids","exp_insurance","exp_lifestyle","exp_other"];
    return ids.reduce((s,id)=>s+n(document.getElementById(id).value),0);
  }
  function getEmergencyFund(){ return n(document.getElementById("emergencyFund").value); }
  function getFundMonths(){
    const exp=getExpenseTotal();
    const fund=getEmergencyFund();
    if(exp<=0) return 0;
    return fund/exp;
  }
  function getPlan(){
    return {
      text:(document.getElementById("planText").value||"").trim(),
      amount:n(document.getElementById("planAmount").value),
      years:n(document.getElementById("planYears").value)
    };
  }
  function fundStatusByType(fm){
    if(userType==="student"){
      if(fm>=3) return {label:"å¾ˆç©© âœ…", msg:"å­¸ç”Ÿç‰ˆï¼šâ‰¥3 å€‹æœˆå¾ˆç©©ï¼Œé‡åˆ°çªç™¼ç‹€æ³æ¯”è¼ƒä¸å®¹æ˜“å½±éŸ¿å­¸æ¥­ã€‚"};
      if(fm>=2) return {label:"è¶³å¤  ğŸ‘", msg:"å­¸ç”Ÿç‰ˆï¼š2â€“3 å€‹æœˆç®—è¶³å¤ ï¼Œå·²ç¶“æœ‰åŸºæœ¬ç·©è¡ã€‚"};
      if(fm>=1) return {label:"å°šå¯ âš ï¸", msg:"å­¸ç”Ÿç‰ˆï¼š1â€“2 å€‹æœˆå°šå¯ï¼Œä½†é‡åˆ°è¼ƒå¤§ç‹€æ³å¯èƒ½æœƒåƒç·Šã€‚"};
      return {label:"ä¸è¶³ â—", msg:"å­¸ç”Ÿç‰ˆï¼š<1 å€‹æœˆåä¸è¶³ï¼Œå»ºè­°å…ˆæŠŠé å‚™é‡‘æ‹‰åˆ° 1â€“2 å€‹æœˆã€‚"};
    }else{
      if(fm>=6) return {label:"å¾ˆç©© âœ…", msg:"ä¸Šç­æ—ç‰ˆï¼šâ‰¥6 å€‹æœˆå¾ˆç©©ï¼Œç¾é‡‘æµé‡åˆ°è®Šå‹•ä¹Ÿæ¯”è¼ƒæ‰›å¾—ä½ã€‚"};
      if(fm>=3) return {label:"è¶³å¤  ğŸ‘", msg:"ä¸Šç­æ—ç‰ˆï¼š3â€“6 å€‹æœˆç®—è¶³å¤ ï¼Œæœ‰åŸºæœ¬å®‰å…¨é‚Šéš›ã€‚"};
      if(fm>=1) return {label:"å°šå¯ âš ï¸", msg:"ä¸Šç­æ—ç‰ˆï¼š1â€“3 å€‹æœˆå°šå¯ï¼Œä½†è‹¥æ”¶å…¥ä¸­æ–·æœƒæ¯”è¼ƒæœ‰å£“åŠ›ã€‚"};
      return {label:"ä¸è¶³ â—", msg:"ä¸Šç­æ—ç‰ˆï¼š<1 å€‹æœˆåä¸è¶³ï¼Œå»ºè­°å…ˆæŠŠé å‚™é‡‘æ‹‰åˆ° 1â€“3 å€‹æœˆã€‚"};
    }
  }

  function updatePreviewAndReport(){
    document.getElementById("reportDate").innerText=todayString();
    const alias=(document.getElementById("clientAlias").value||"").trim();
    document.getElementById("reportAlias").innerText=alias?alias:"ï¼ˆæœªå¡«ï¼‰";

    const income=getMonthlyIncome();
    const exp=getExpenseTotal();
    const remain=income-exp;

    document.getElementById("expenseTotal").innerText=fmt(exp);
    document.getElementById("remainingDisplay").innerText=fmt(remain);

    document.getElementById("reportIncome").innerText=fmt(income);
    document.getElementById("reportExpense").innerText=fmt(exp);
    document.getElementById("reportRemaining").innerText=fmt(remain);

    const fund=getEmergencyFund();
    const fm=getFundMonths();
    const fmDisp=fm?fm.toFixed(1):"0";
    document.getElementById("fundMonths").innerText=fmDisp;
    document.getElementById("reportFund").innerText=fmt(fund);
    document.getElementById("reportFundMonths").innerText=fmDisp;

    const st=fundStatusByType(fm);
    document.getElementById("fundStatus").innerText=st.label;
    document.getElementById("fundHint").innerText="é å‚™é‡‘æœˆæ•¸ = ç·Šæ€¥é å‚™é‡‘ Ã· æ¯æœˆæ—¥å¸¸é–‹éŠ·åˆè¨ˆ\n"+st.msg;
    document.getElementById("reportFundStatus").innerText=st.label;

    const plan=getPlan();
    document.getElementById("reportPlanText").innerText=plan.text?plan.text:"ï¼ˆæœªå¡«ï¼‰";
    document.getElementById("reportPlanAmount").innerText=fmt(plan.amount);
    document.getElementById("reportPlanYears").innerText=plan.years?`${plan.years} å¹´`:"å°šæœªç¢ºå®š";
  }

  function setUserType(type){
    userType=type;
    document.getElementById("btnStudent").classList.toggle("active", type==="student");
    document.getElementById("btnWorker").classList.toggle("active", type==="worker");
    updatePreviewAndReport();
  }

  function scoreSafety(){
    const v=document.getElementById("insurance").value;
    if(v==="basic") return 3;
    if(v==="partial") return 2;
    return 1;
  }
  function scorePreparation(){
    const remain=getMonthlyIncome()-getExpenseTotal();
    const fm=getFundMonths();
    const plan=getPlan();
    const hasPlanText=!!plan.text;
    const hasPlanNumbers=(plan.amount>0)||(plan.years>0);

    if(userType==="student"){
      if(fm>=2) return 3;
      if(fm>0) return 2;
      if(getEmergencyFund()>0) return 2;
      return 1;
    }

    let s=1;
    if(remain>0) s=2;
    if(remain>0 && fm>=3) s=3;
    if(hasPlanText && hasPlanNumbers) s=Math.min(3, s+1);
    return Math.max(1, Math.min(3, s));
  }
  function scoreGrowth(){
    return document.getElementById("investment").value==="yes"?3:2;
  }

  function analyze(){
    updatePreviewAndReport();
    const safety=scoreSafety();
    const prep=scorePreparation();
    const growth=scoreGrowth();

    if(chart) chart.destroy();
    chart=new Chart(document.getElementById("triangleChart"),{
      type:"radar",
      data:{
        labels:["å®‰å…¨","æº–å‚™","æˆé•·"],
        datasets:[{
          data:[safety,prep,growth],
          backgroundColor:"rgba(31,111,255,0.2)",
          borderColor:"#1f6fff",
          borderWidth:2
        }]
      },
      options:{
        maintainAspectRatio:false,
        plugins:{legend:{display:false}},
        scales:{r:{min:0,max:3,ticks:{display:false}}}
      }
    });

    const summaryEl=document.getElementById("summary");
    const nextStepEl=document.getElementById("nextStep");

    const fm=getFundMonths();
    const plan=getPlan();
    const st=fundStatusByType(fm);

    if(safety===1){
      summaryEl.innerText="ç›®å‰æœ€éœ€è¦å…ˆè™•ç†çš„ä¸æ˜¯æŠ•è³‡æˆ–å­˜å¾ˆå¤šï¼Œè€Œæ˜¯ç¢ºä¿ç™¼ç”Ÿç‹€æ³æ™‚ï¼Œç”Ÿæ´»èˆ‡æ”¶å…¥ä¸æœƒè¢«æ‰“æ–·ã€‚";
    }else if(prep===1){
      summaryEl.innerText="ä½ ç¾åœ¨çš„é—œéµæ˜¯æŠŠç·Šæ€¥é å‚™é‡‘èˆ‡åŸºæœ¬é¢¨éšªå…ˆé¡§å¥½ï¼Œè®“äººç”Ÿè¨ˆç•«ä¸æœƒè¢«çªç™¼äº‹ä»¶æ‰“æ–·ã€‚";
    }else{
      summaryEl.innerText="ä½ çš„è²¡å‹™çµæ§‹å·²æœ‰åŸºç¤ï¼Œå¯ä»¥ä¸€æ­¥ä¸€æ­¥ä¾†ï¼›å…ˆç©©å®šé¢¨éšªèˆ‡é å‚™é‡‘ï¼Œå†æŠŠè¨ˆç•«è½åœ°ã€‚";
    }

    const fundLine=(getExpenseTotal()>0)
      ? `é å‚™é‡‘ç´„å¯æ’ ${fm?fm.toFixed(1):"0"} å€‹æœˆï¼ˆ${st.label}ï¼‰ã€‚`
      : `é å‚™é‡‘ç‹€æ…‹ï¼š${st.label}ï¼ˆå»ºè­°å…ˆå¡«æ—¥å¸¸é–‹éŠ·ï¼Œæœˆæ•¸æœƒæ›´æº–ï¼‰ã€‚`;

    const planLine=plan.text
      ? `3â€“5 å¹´è¨ˆç•«ï¼š${plan.text}${plan.amount>0?`ï¼ˆç´„ ${fmt(plan.amount)}ï¼‰`:""}${plan.years>0?`ï¼Œç›®æ¨™ ${plan.years} å¹´å…§å®Œæˆã€‚`:""}`
      : "3â€“5 å¹´è¨ˆç•«ï¼šå°šæœªå¡«å¯«ï¼ˆå»ºè­°å…ˆå¯«ä¸‹ç›®æ¨™å…§å®¹èˆ‡å¤§æ¦‚é‡‘é¡ï¼‰ã€‚";

    nextStepEl.innerText=
      "ä¸‹ä¸€æ­¥å»ºè­°ï¼ˆå…ˆæŠŠçµæ§‹ç©©ä½ï¼‰ï¼š\n"+
      `â€¢ ${fundLine}\n`+
      `â€¢ ${planLine}\n\n`+
      "1) å…ˆç¢ºèªé†«ç™‚/æ„å¤–æ˜¯å¦è¶³å¤ ï¼ˆé¿å…çªç™¼äº‹ä»¶æ‰“äº‚ç”Ÿæ´»ï¼‰\n"+
      "2) å†çœ‹æ˜¯å¦éœ€è¦è²¬ä»»å‹ä¿éšœï¼ˆå°å®¶åº­/æœªä¾†çš„æ‰¿æ“”ï¼‰\n"+
      "3) æœ€å¾Œæ‰è«‡æ›´é•·æœŸçš„å®‰æ’ï¼ˆåˆ†éšæ®µå®Œæˆï¼‰";

    document.getElementById("focusResult").innerText="";
  }

  function openModal(){ document.getElementById("modal").style.display="block"; }
  function closeModal(){ document.getElementById("modal").style.display="none"; }

  function selectFocus(type){
    const focusResultEl=document.getElementById("focusResult");
    const talkCardEl=document.getElementById("talkCard");
    const nextStepEl=document.getElementById("nextStep");

    if(userType==="student"){
      if(type==="life") focusText="ä½ é¸æ“‡çš„æ˜¯ï¼šç”Ÿæ´»ä¸ä¸­æ–·ã€‚é‡é»æ˜¯é¿å…æ„å¤–æˆ–ç”Ÿç—…å½±éŸ¿å­¸æ¥­èˆ‡ç”Ÿæ´»ã€‚";
      if(type==="family") focusText="ä½ é¸æ“‡çš„æ˜¯ï¼šä¸æ‹–ç´¯å®¶äººã€‚å…ˆç”¨æœ€åŸºæœ¬ã€è² æ“”å¾—èµ·çš„æ–¹å¼æŠŠé¢¨éšªé¡§å¥½ã€‚";
      if(type==="future") focusText="ä½ é¸æ“‡çš„æ˜¯ï¼šæœªä¾†è¨ˆç•«ä¸è¢«æ‰“æ–·ã€‚å…ˆé¡§å¥½é¢¨éšªï¼Œè®“é¸æ“‡ä¸æœƒè¢«è¿«ä¸­æ–·ã€‚";
      nextStepEl.innerText=
        "ä¸‹ä¸€æ­¥å»ºè­°ï¼ˆå…·é«”èªªæ˜é‡é»ï¼‰ï¼š\n"+
        "1) åŸºæœ¬é†«ç™‚ä¿éšœï¼ˆä½é™¢ã€æ‰‹è¡“ï¼‰\n"+
        "2) æ„å¤–ä¿éšœï¼ˆçªç™¼äº‹ä»¶ä¸å½±éŸ¿å­¸æ¥­/ç”Ÿæ´»ï¼‰\n"+
        "3) å°é¡å£½éšªï¼ˆä¿è­·æœªä¾†é¸æ“‡æ¬Šï¼‰\n\n"+
        "åŸå‰‡ï¼šä¿è²»è² æ“”è¼•ã€ä¸é–é•·æœŸã€å…ˆé¡§é¢¨éšªä¸è«‡æŠ•è³‡ã€‚";
    }else{
      if(type==="life") focusText="ä½ é¸æ“‡çš„æ˜¯ï¼šç”Ÿæ´»ä¸ä¸­æ–·ã€‚é‡é»åœ¨é¿å…æ”¶å…¥ä¸­æ–·å½±éŸ¿ç”Ÿæ´»ã€‚";
      if(type==="family") focusText="ä½ é¸æ“‡çš„æ˜¯ï¼šä¸æ‹–ç´¯å®¶äººã€‚é‡é»åœ¨è²¬ä»»é¢¨éšªçš„æ‰¿æ“”ã€‚";
      if(type==="future") focusText="ä½ é¸æ“‡çš„æ˜¯ï¼šæœªä¾†è¨ˆç•«ä¸è¢«æ‰“æ–·ã€‚é¿å…ä¸€æ¬¡äº‹ä»¶æ‰“äº‚å¤šå¹´åŠªåŠ›ã€‚";
      nextStepEl.innerText=
        "ä¸‹ä¸€æ­¥å»ºè­°ï¼ˆå…·é«”èªªæ˜é‡é»ï¼‰ï¼š\n"+
        "1) åŸºæœ¬é†«ç™‚èˆ‡æ„å¤–ï¼ˆé¿å…æ”¶å…¥ä¸­æ–·ï¼‰\n"+
        "2) å£½éšªè²¬ä»»ä¿éšœï¼ˆå°å®¶äººè² è²¬ï¼‰\n"+
        "3) è¦–ç¾é‡‘æµè£œå¼·é•·æœŸä¿éšœï¼ˆåˆ†éšæ®µå®Œæˆï¼‰\n\n"+
        "åŸå‰‡ï¼šä¸å½±éŸ¿ç”Ÿæ´»å“è³ªã€åˆ†éšæ®µå®Œæˆã€å…ˆç©©å®šå†æ“´å¤§ã€‚";
    }
    talkCardEl.innerText=focusText;
    focusResultEl.innerText=focusText;
  }

  function downloadPDF(){
    const summaryText=(document.getElementById("summary").innerText||"").trim();
    if(!summaryText){ alert("è«‹å…ˆæŒ‰ã€Œåˆ†ææˆ‘çš„ç†è²¡é‡‘ä¸‰è§’ã€ç”¢ç”Ÿå ±å‘Šå…§å®¹ï¼Œå†ä¸‹è¼‰ PDFã€‚"); return; }

    updatePreviewAndReport();

    const alias=(document.getElementById("clientAlias").value||"").trim();
    const filenameBase=alias?`ç†è²¡é‡‘ä¸‰è§’_çµæ§‹æª¢è¦–å ±å‘Š_${alias}`:"ç†è²¡é‡‘ä¸‰è§’_çµæ§‹æª¢è¦–å ±å‘Š";

    const canvas=document.getElementById("triangleChart");
    const dataUrl=canvas.toDataURL("image/png",1.0);

    const img=document.createElement("img");
    img.src=dataUrl;
    img.style.width="100%";
    img.style.maxWidth="360px";
    img.style.display="block";
    img.style.margin="0 auto";

    const wrapper=canvas.parentElement;
    const backup=canvas.style.display;
    canvas.style.display="none";
    wrapper.appendChild(img);

    requestAnimationFrame(()=>{
      const opt={
        margin:0.8,
        filename:`${filenameBase}.pdf`,
        image:{type:"jpeg",quality:0.98},
        html2canvas:{scale:2,backgroundColor:"#ffffff",useCORS:true},
        jsPDF:{unit:"cm",format:"a4",orientation:"portrait"}
      };
      html2pdf().set(opt).from(document.getElementById("report")).save().then(()=>{
        img.remove(); canvas.style.display=backup||"block";
      }).catch(()=>{
        img.remove(); canvas.style.display=backup||"block";
        alert("PDF ç”¢ç”Ÿå¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡ï¼ˆå»ºè­°ç”¨ Chromeï¼‰ã€‚");
      });
    });
  }

  function resetAll(){
    document.getElementById("clientAlias").value="";
    document.getElementById("incomeType").value="month";
    document.getElementById("incomeAmount").value="";
    ["exp_housing","exp_carloan","exp_utilities","exp_food","exp_transport","exp_kids","exp_insurance","exp_lifestyle","exp_other"].forEach(id=>document.getElementById(id).value="");
    document.getElementById("emergencyFund").value="";
    document.getElementById("planText").value="";
    document.getElementById("planAmount").value="";
    document.getElementById("planYears").value="0";
    document.getElementById("investment").value="none";
    document.getElementById("insurance").value="none";
    document.getElementById("summary").innerText="";
    document.getElementById("focusResult").innerText="";
    document.getElementById("talkCard").innerText="";
    document.getElementById("nextStep").innerText="";
    focusText="";
    if(chart){ chart.destroy(); chart=null; }
    setUserType("student");
    closeModal();
    document.getElementById("incomeLabel").innerText="æœˆæ”¶å…¥";
    document.getElementById("reportDate").innerText=todayString();
    updatePreviewAndReport();
    document.getElementById("incomeAmount").focus();
  }

  document.addEventListener("DOMContentLoaded",()=>{
    document.getElementById("reportDate").innerText=todayString();

    document.getElementById("btnStudent").addEventListener("click",()=>setUserType("student"));
    document.getElementById("btnWorker").addEventListener("click",()=>setUserType("worker"));

    const incomeTypeEl=document.getElementById("incomeType");
    const incomeLabelEl=document.getElementById("incomeLabel");
    function syncIncomeLabel(){
      incomeLabelEl.innerText=incomeTypeEl.value==="year"?"å¹´æ”¶å…¥":"æœˆæ”¶å…¥";
      updatePreviewAndReport();
    }
    incomeTypeEl.addEventListener("change",syncIncomeLabel);

    document.getElementById("clientAlias").addEventListener("input",updatePreviewAndReport);
    document.getElementById("incomeAmount").addEventListener("input",updatePreviewAndReport);
    ["exp_housing","exp_carloan","exp_utilities","exp_food","exp_transport","exp_kids","exp_insurance","exp_lifestyle","exp_other"].forEach(id=>{
      document.getElementById(id).addEventListener("input",updatePreviewAndReport);
    });
    document.getElementById("emergencyFund").addEventListener("input",updatePreviewAndReport);
    document.getElementById("planText").addEventListener("input",updatePreviewAndReport);
    document.getElementById("planAmount").addEventListener("input",updatePreviewAndReport);
    document.getElementById("planYears").addEventListener("change",updatePreviewAndReport);
    document.getElementById("investment").addEventListener("change",updatePreviewAndReport);
    document.getElementById("insurance").addEventListener("change",updatePreviewAndReport);

    document.getElementById("btnAnalyze").addEventListener("click",analyze);
    document.getElementById("btnOpenModal").addEventListener("click",openModal);
    document.getElementById("btnCloseModal").addEventListener("click",closeModal);
    document.getElementById("btnPDF").addEventListener("click",downloadPDF);
    document.getElementById("btnReset").addEventListener("click",resetAll);

    document.querySelectorAll(".option-btn").forEach(btn=>{
      btn.addEventListener("click",()=>selectFocus(btn.dataset.focus));
    });

    syncIncomeLabel();
    updatePreviewAndReport();
  });
</script>
</body>
</html>
