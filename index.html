<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ç†è²¡é‡‘ä¸‰è§’ï½œè²¡å‹™çµæ§‹æª¢è¦–</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- PDF: html2canvas + jsPDFï¼ˆé¿å… html2pdf ç©ºç™½ï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    body{font-family:system-ui,-apple-system,BlinkMacSystemFont;background:#f7f8fa;margin:0;padding:16px}
    h1{text-align:center;margin:0 0 6px}
    .subtitle{text-align:center;color:#555;margin:0}
    .desc{text-align:center;color:#888;font-size:14px;margin:8px 0 12px}
    .card{background:#fff;border-radius:12px;padding:16px;margin-bottom:16px;box-shadow:0 2px 8px rgba(0,0,0,.05)}
    label{display:block;margin-top:12px;font-weight:900}
    .sub-label{font-weight:700;margin-top:10px;color:#333}
    .hint{font-size:13px;color:#666;margin-top:8px;line-height:1.5;white-space:pre-line}
    input,select,textarea{width:100%;padding:10px;margin-top:6px;font-size:16px;box-sizing:border-box}
    textarea{min-height:72px;resize:vertical}
    button{width:100%;padding:14px;font-size:18px;border:none;border-radius:8px;margin-top:12px;cursor:pointer}
    .primary{background:#1f6fff;color:#fff}
    .cta{background:#e53935;color:#fff}
    .secondary{background:#4caf50;color:#fff}
    .reset{background:#9e9e9e;color:#fff}

    .result{font-size:18px;line-height:1.6;margin-top:12px;white-space:pre-line}
    .calc-box{margin-top:12px;padding:12px;border-radius:10px;background:#f2f6ff}
    .calc-title{font-weight:1000;margin-bottom:6px}
    .calc-row{display:flex;justify-content:space-between;gap:12px}
    .calc-row span{font-weight:1000}
    .status-chip{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:900;font-size:13px;background:#eee;color:#333;margin-top:8px}

    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:720px){ .grid-2{grid-template-columns:1fr} }

    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:999}
    .modal-content{background:#fff;margin:10% auto;padding:18px;border-radius:12px;width:92%;max-width:460px}
    .option-btn{width:100%;padding:12px;border-radius:8px;border:1px solid #ccc;background:#f7f7f7;margin-top:8px;font-size:16px;cursor:pointer}

    #reportHeader{margin-bottom:10px;padding-bottom:10px;border-bottom:1px solid #eee}
    .report-title{font-size:20px;font-weight:1000;margin:0}
    .report-sub{color:#555;margin:4px 0 0}
    .report-meta{color:#777;font-size:13px;margin-top:8px;line-height:1.5}
    .small-note{font-size:13px;color:#777;margin-top:12px}
  </style>
</head>

<body>
  <h1>ç†è²¡é‡‘ä¸‰è§’</h1>
  <div class="subtitle">å¿«é€Ÿçœ‹æ‡‚ä½ çš„è²¡å‹™çµæ§‹</div>
  <div class="desc">ç¾å ´å¡«å¯« â†’ ç³»çµ±ç®—å‡ºç¾é‡‘æµèˆ‡æº–å‚™åº¦ â†’ ä¾å®¢æˆ¶é‡è¦–é»çµ¦å‡ºä¸‹ä¸€æ­¥ï¼ˆå¯ä¸‹è¼‰PDFï¼‰</div>

  <!-- Input -->
  <div class="card">
    <label>å®¢æˆ¶ä»£ç¨±ï¼ˆé¸å¡«ï¼‰</label>
    <input type="text" id="clientAlias" placeholder="ä¾‹å¦‚ï¼šç‹å…ˆç”Ÿ / å°æ½” / Aå®¢ï¼ˆé¿å…å¡«èº«åˆ†è­‰ã€é›»è©±ç­‰å€‹è³‡ï¼‰" />

    <label>æ”¶å…¥è¼¸å…¥æ–¹å¼</label>
    <select id="incomeType">
      <option value="month">æœˆæ”¶å…¥</option>
      <option value="year">å¹´æ”¶å…¥</option>
    </select>

    <label id="incomeLabel">æœˆæ”¶å…¥</label>
    <input type="number" id="incomeAmount" placeholder="ä¾‹å¦‚ï¼š45000" inputmode="numeric"/>

    <!-- Housing -->
    <label>å±…ä½ç‹€æ³ï¼ˆæˆ¿ç§Ÿ/æˆ¿è²¸ï¼‰</label>
    <div class="grid-2">
      <div>
        <div class="sub-label">ç›®å‰æ˜¯</div>
        <select id="housingType">
          <option value="rent">ç§Ÿå±‹ï¼ˆæˆ¿ç§Ÿï¼‰</option>
          <option value="mortgage">æœ‰æˆ¿è²¸</option>
          <option value="none">ç„¡ï¼ˆå®¶è£¡/å…¬å¸å®¿èˆ/å…æˆ¿ç§Ÿï¼‰</option>
        </select>
      </div>
      <div>
        <div class="sub-label">å‚™è¨»ï¼ˆé¸å¡«ï¼‰</div>
        <input type="text" id="housingNote" placeholder="ä¾‹å¦‚ï¼šè·Ÿå®¶äººåŒä½ / å…±åŒåˆ†æ”¤ / æˆ¿è²¸å‰© 18 å¹´â€¦" />
      </div>
    </div>

    <label>æ—¥å¸¸é–‹éŠ·ï¼ˆæ¯æœˆï¼Œè«‹é€é …å¡«å¯«ï¼‰</label>
    <div class="sub-label">æˆ¿ç§Ÿ/æˆ¿è²¸ï¼ˆä¾ä¸Šæ–¹ç‹€æ³å¡«é‡‘é¡ï¼‰</div>
    <input type="number" id="exp_housing" placeholder="0" inputmode="numeric"/>
    <div class="sub-label">è»Šè²¸</div>
    <input type="number" id="exp_carloan" placeholder="0" inputmode="numeric"/>
    <div class="sub-label">æ°´é›»ç“¦æ–¯/ç¶²è·¯æ‰‹æ©Ÿ</div>
    <input type="number" id="exp_utilities" placeholder="0" inputmode="numeric"/>
    <div class="sub-label">é¤é£²ï¼ˆå¤–é£Ÿ/è²·èœï¼‰</div>
    <input type="number" id="exp_food" placeholder="0" inputmode="numeric"/>
    <div class="sub-label">äº¤é€šï¼ˆé€šå‹¤/æ²¹éŒ¢/åœè»Šï¼‰</div>
    <input type="number" id="exp_transport" placeholder="0" inputmode="numeric"/>
    <div class="sub-label">æ•™è‚²/è‚²å…’ï¼ˆå­¸è²»/æ‰è—/ä¿æ¯ï¼‰</div>
    <input type="number" id="exp_kids" placeholder="0" inputmode="numeric"/>
    <div class="sub-label">å¨›æ¨‚/è³¼ç‰©/ç¤¾äº¤</div>
    <input type="number" id="exp_lifestyle" placeholder="0" inputmode="numeric"/>
    <div class="sub-label">å…¶ä»–å›ºå®šæ”¯å‡º</div>
    <input type="number" id="exp_other" placeholder="0" inputmode="numeric"/>

    <!-- Insurance: client fill monthly premium amount + note -->
    <label>ä¿éšªï¼ˆå®¢æˆ¶è‡ªè¡Œå¡«å¯«ï¼‰</label>
    <div class="grid-2">
      <div>
        <div class="sub-label">æ¯æœˆä¿è²»ï¼ˆå¤§ç´„å³å¯ï¼‰</div>
        <input type="number" id="insuranceMonthly" placeholder="ä¾‹å¦‚ï¼š2500" inputmode="numeric"/>
      </div>
      <div>
        <div class="sub-label">å‚™è¨»ï¼ˆé¸å¡«ï¼‰</div>
        <input type="text" id="insuranceNote" placeholder="ä¾‹å¦‚ï¼šåªæœ‰åœ˜ä¿ / ä¸»è¦æ˜¯é†«ç™‚ / å®¶äººå¹«è²·â€¦" />
      </div>
    </div>

    <div class="calc-box">
      <div class="calc-title">ç³»çµ±è¨ˆç®—ï¼ˆç¾é‡‘æµï¼‰</div>
      <div class="calc-row"><div>æ¯æœˆæ—¥å¸¸é–‹éŠ·åˆè¨ˆï¼ˆå«ä¿è²»ï¼‰</div><div><span id="expenseTotal">0</span></div></div>
      <div class="calc-row" style="margin-top:6px;"><div>å¯æ”¯é…æ‰€å¾—ï¼ˆæœˆå‰©é¤˜ï¼‰</div><div><span id="remainingDisplay">0</span></div></div>
      <div class="hint">å¯æ”¯é…æ‰€å¾— = æœˆæ”¶å…¥ï¼ˆæ›ç®—ï¼‰ - æ—¥å¸¸é–‹éŠ·åˆè¨ˆï¼ˆå«ä¿è²»ï¼‰</div>
    </div>

    <!-- Emergency fund -->
    <label>ç·Šæ€¥é å‚™é‡‘ï¼ˆç›®å‰å·²å­˜çš„é‡‘é¡ï¼‰</label>
    <input type="number" id="emergencyFund" placeholder="ä¾‹å¦‚ï¼š120000" inputmode="numeric"/>

    <div class="calc-box" style="background:#f7f7ff;">
      <div class="calc-title">ç³»çµ±è¨ˆç®—ï¼ˆé å‚™é‡‘ï¼‰</div>
      <div class="calc-row"><div>é å‚™é‡‘å¯æ”¯æ’ï¼ˆæœˆï¼‰</div><div><span id="fundMonths">0</span></div></div>
      <div class="calc-row" style="margin-top:6px;"><div>ç‹€æ…‹æç¤º</div><div><span id="fundStatus" class="status-chip">å°šæœªè©•ä¼°</span></div></div>
      <div class="hint" id="fundHint">é å‚™é‡‘æœˆæ•¸ = ç·Šæ€¥é å‚™é‡‘ Ã· æ¯æœˆæ—¥å¸¸é–‹éŠ·åˆè¨ˆï¼ˆå«ä¿è²»ï¼‰</div>
    </div>

    <!-- Plan -->
    <label>3â€“5 å¹´è¨ˆç•«ï¼ˆè«‹å®¢æˆ¶è‡ªå·±å¡«ï¼‰</label>
    <div class="sub-label">è¨ˆç•«å…§å®¹ï¼ˆå¯å¤šé …ï¼‰</div>
    <textarea id="planText" placeholder="ä¾‹å¦‚ï¼šçµå©šã€è²·è»Šã€é€²ä¿®ã€å‡ºåœ‹ã€å‰µæ¥­ã€æˆ¿å±‹é ­æœŸæ¬¾..."></textarea>
    <div class="grid-2">
      <div>
        <div class="sub-label">ç›®æ¨™é‡‘é¡ï¼ˆä¼°è¨ˆå³å¯ï¼‰</div>
        <input type="number" id="planAmount" placeholder="ä¾‹å¦‚ï¼š300000" inputmode="numeric"/>
      </div>
      <div>
        <div class="sub-label">é è¨ˆå¹¾å¹´å®Œæˆï¼ˆ3â€“5 å¹´ï¼‰</div>
        <select id="planYears">
          <option value="0">å°šæœªç¢ºå®š</option>
          <option value="3">3 å¹´</option>
          <option value="4">4 å¹´</option>
          <option value="5">5 å¹´</option>
        </select>
      </div>
    </div>

    <!-- Investment -->
    <label>æŠ•è³‡ï¼ˆå®¢æˆ¶è‡ªè¡Œå¡«å¯«ï¼‰</label>
    <div class="grid-2">
      <div>
        <div class="sub-label">æ¯æœˆæŠ•è³‡é‡‘é¡ï¼ˆå¤§ç´„å³å¯ï¼‰</div>
        <input type="number" id="investmentMonthly" placeholder="ä¾‹å¦‚ï¼š3000" inputmode="numeric"/>
      </div>
      <div>
        <div class="sub-label">æŠ•è³‡æ–¹å¼ï¼ˆå¯å¤šé¸ï¼Œæˆ–å‚™è¨»ï¼‰</div>
        <input type="text" id="investmentMethods" placeholder="ä¾‹å¦‚ï¼šå®šæœŸå®šé¡ETF/åŸºé‡‘/è‚¡ç¥¨/å„²è“„/åŠ å¯†/å…¶ä»–â€¦" />
      </div>
    </div>

    <!-- Basic insurance status (for scoring) -->
    <label>ä¿éšœè‡ªè©•ï¼ˆåªç”¨æ–¼çµæ§‹åˆ¤è®€ï¼‰</label>
    <select id="insuranceStatus">
      <option value="none">æ²’æœ‰/å¾ˆå°‘</option>
      <option value="partial">æœ‰ä½†ä¸å®Œæ•´</option>
      <option value="basic">è¦ºå¾—åŸºæœ¬ä¿éšœå®Œæ•´</option>
    </select>

    <button class="primary" id="btnAnalyze" type="button">åˆ†ææˆ‘çš„ç†è²¡é‡‘ä¸‰è§’</button>
  </div>

  <!-- Report -->
  <div class="card" id="report">
    <div id="reportHeader">
      <p class="report-title">ç†è²¡é‡‘ä¸‰è§’ï½œè²¡å‹™çµæ§‹æª¢è¦–å ±å‘Š</p>
      <p class="report-sub">å®‰å…¨ Ã— æº–å‚™ Ã— æˆé•·ï¼ˆåªçœ‹çµæ§‹ï¼Œä¸è«‡å ±é…¬ï¼‰</p>
      <div class="report-meta">
        <div>æ—¥æœŸï¼š<span id="reportDate"></span></div>
        <div>å®¢æˆ¶ä»£ç¨±ï¼š<span id="reportAlias">ï¼ˆæœªå¡«ï¼‰</span></div>
      </div>
    </div>

    <div class="calc-box" style="background:#f7f7ff;">
      <div class="calc-title">ç¾æ³æ‘˜è¦ï¼ˆæ¯æœˆï¼‰</div>
      <div class="calc-row"><div>æœˆæ”¶å…¥ï¼ˆæ›ç®—ï¼‰</div><div><span id="reportIncome">0</span></div></div>
      <div class="calc-row" style="margin-top:6px;"><div>æ—¥å¸¸é–‹éŠ·åˆè¨ˆï¼ˆå«ä¿è²»ï¼‰</div><div><span id="reportExpense">0</span></div></div>
      <div class="calc-row" style="margin-top:6px;"><div>å¯æ”¯é…æ‰€å¾—ï¼ˆæœˆå‰©é¤˜ï¼‰</div><div><span id="reportRemaining">0</span></div></div>

      <div class="calc-row" style="margin-top:6px;"><div>æˆ¿ç§Ÿ/æˆ¿è²¸ç‹€æ³</div><div><span id="reportHousingType">â€”</span></div></div>
      <div class="calc-row" style="margin-top:6px;"><div>å‚™è¨»</div><div><span id="reportHousingNote">â€”</span></div></div>

      <div class="calc-row" style="margin-top:6px;"><div>ç·Šæ€¥é å‚™é‡‘</div><div><span id="reportFund">0</span></div></div>
      <div class="calc-row" style="margin-top:6px;"><div>é å‚™é‡‘å¯æ”¯æ’ï¼ˆæœˆï¼‰</div><div><span id="reportFundMonths">0</span></div></div>
      <div class="calc-row" style="margin-top:6px;"><div>é å‚™é‡‘ç‹€æ…‹</div><div><span id="reportFundStatus">å°šæœªè©•ä¼°</span></div></div>

      <div class="calc-row" style="margin-top:6px;"><div>æ¯æœˆä¿è²»ï¼ˆå®¢æˆ¶å¡«ï¼‰</div><div><span id="reportInsMonthly">0</span></div></div>
      <div class="calc-row" style="margin-top:6px;"><div>ä¿éšªå‚™è¨»</div><div><span id="reportInsNote">â€”</span></div></div>

      <div class="calc-row" style="margin-top:6px;"><div>æ¯æœˆæŠ•è³‡é‡‘é¡ï¼ˆå®¢æˆ¶å¡«ï¼‰</div><div><span id="reportInvMonthly">0</span></div></div>
      <div class="calc-row" style="margin-top:6px;"><div>æŠ•è³‡æ–¹å¼ï¼ˆå®¢æˆ¶å¡«ï¼‰</div><div><span id="reportInvMethods">â€”</span></div></div>
    </div>

    <div class="calc-box" style="background:#fff7f2;">
      <div class="calc-title">3â€“5 å¹´è¨ˆç•«</div>
      <div class="hint" style="margin-top:0;">
        å…§å®¹ï¼š<span id="reportPlanText">ï¼ˆæœªå¡«ï¼‰</span><br/>
        ç›®æ¨™é‡‘é¡ï¼š<span id="reportPlanAmount">0</span><br/>
        å¹´é™ï¼š<span id="reportPlanYears">å°šæœªç¢ºå®š</span>
      </div>
    </div>

    <div style="max-width:360px;margin:0 auto;">
      <canvas id="triangleChart" height="260"></canvas>
    </div>

    <div id="summary" class="result"></div>
    <div id="focusResult" class="result"></div>
    <div id="nextStep" class="result" style="background:#f7f7ff;padding:12px;border-radius:10px;"></div>

    <p class="small-note">
      æœ¬å ±å‘Šåƒ…ç‚ºè²¡å‹™çµæ§‹æª¢è¦–ï¼Œä¸æ¶‰åŠæŠ•è³‡å ±é…¬ã€æ”¶ç›Šæ‰¿è«¾æˆ–ç‰¹å®šå•†å“æ¨è–¦ã€‚
      å¾ŒçºŒè¦åŠƒå°‡ä»¥é¢è«‡ç¢ºèªéœ€æ±‚èˆ‡å¯è² æ“”æ€§ç‚ºæº–ã€‚
    </p>
  </div>

  <button class="cta" id="btnOpenModal" type="button">æˆäº¤æŒ‰éˆ•ï¼šé¸å®¢æˆ¶æœ€é‡è¦–çš„ï¼ˆæœƒå½±éŸ¿æœ€å¾Œå»ºè­°ï¼‰</button>
  <button class="secondary" id="btnPDF" type="button">ä¸‹è¼‰æœ¬æ¬¡åˆ†æå ±å‘Šï¼ˆPDFï¼‰</button>
  <button class="reset" id="btnReset" type="button">é‡è¨­ï¼ä¸‹ä¸€ä½å®¢æˆ¶</button>

  <!-- Modal -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <h3 style="margin:0 0 8px;">å¦‚æœåªèƒ½å…ˆé¡§å¥½ä¸€ä»¶äº‹ï¼Œä½ ç¾åœ¨æœ€åœ¨æ„å“ªä¸€å¡Šï¼Ÿ</h3>
      <button class="option-btn" type="button" data-focus="life">ç”Ÿæ´»ä¸ä¸­æ–·</button>
      <button class="option-btn" type="button" data-focus="family">ä¸æ‹–ç´¯å®¶äºº</button>
      <button class="option-btn" type="button" data-focus="future">æœªä¾†è¨ˆç•«ä¸è¢«æ‰“æ–·</button>
      <p id="talkCard" style="margin-top:12px;line-height:1.6;"></p>
      <button class="primary" id="btnCloseModal" type="button">äº†è§£ï¼Œå¥—ç”¨å»ºè­°ä¸¦é—œé–‰</button>
    </div>
  </div>

<script>
  let chart=null;

  // ç›®å‰å®¢æˆ¶é¸æ“‡çš„é‡è¦–é …ç›®ï¼ˆæœƒå½±éŸ¿æœ€å¾Œå»ºè­°ï¼‰
  let currentFocus="life";

  const n=v=>Number(v||0);
  const fmt=v=>Math.round(Number(v||0)).toLocaleString("zh-Hant-TW");
  function todayString(){
    const d=new Date();
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
  }

  function getMonthlyIncome(){
    const t=document.getElementById("incomeType").value;
    const a=n(document.getElementById("incomeAmount").value);
    return t==="year"?a/12:a;
  }

  function getInsuranceMonthly(){ return n(document.getElementById("insuranceMonthly").value); }
  function getInvestmentMonthly(){ return n(document.getElementById("investmentMonthly").value); }

  function getExpenseTotal(){
    const ids=["exp_housing","exp_carloan","exp_utilities","exp_food","exp_transport","exp_kids","exp_lifestyle","exp_other"];
    const base=ids.reduce((s,id)=>s+n(document.getElementById(id).value),0);
    // ä¿è²»ä¹Ÿç®—å…¥æ—¥å¸¸é–‹éŠ·
    return base + getInsuranceMonthly();
  }

  function getEmergencyFund(){ return n(document.getElementById("emergencyFund").value); }
  function getFundMonths(){
    const exp=getExpenseTotal();
    const fund=getEmergencyFund();
    if(exp<=0) return 0;
    return fund/exp;
  }

  function getPlan(){
    return {
      text:(document.getElementById("planText").value||"").trim(),
      amount:n(document.getElementById("planAmount").value),
      years:n(document.getElementById("planYears").value)
    };
  }

  function housingTypeLabel(v){
    if(v==="rent") return "ç§Ÿå±‹ï¼ˆæˆ¿ç§Ÿï¼‰";
    if(v==="mortgage") return "æœ‰æˆ¿è²¸";
    return "ç„¡ï¼ˆå…æˆ¿ç§Ÿï¼‰";
  }

  // å–®ä¸€é–€æª»ï¼ˆä¸åˆ†å­¸ç”Ÿ/ä¸Šç­æ—ï¼‰
  function fundStatus(fm){
    if(fm>=6) return {label:"å¾ˆç©© âœ…", msg:"é å‚™é‡‘ â‰¥6 å€‹æœˆï¼šç¾é‡‘æµé‡åˆ°è®Šå‹•ä¹Ÿæ¯”è¼ƒæ‰›å¾—ä½ã€‚"};
    if(fm>=3) return {label:"è¶³å¤  ğŸ‘", msg:"é å‚™é‡‘ 3â€“6 å€‹æœˆï¼šåŸºæœ¬å®‰å…¨é‚Šéš›ä¸éŒ¯ã€‚"};
    if(fm>=1) return {label:"å°šå¯ âš ï¸", msg:"é å‚™é‡‘ 1â€“3 å€‹æœˆï¼šå°šå¯ï¼Œä½†æ”¶å…¥ä¸­æ–·æ™‚å£“åŠ›æœƒä¸Šä¾†ã€‚"};
    return {label:"ä¸è¶³ â—", msg:"é å‚™é‡‘ <1 å€‹æœˆï¼šåä¸è¶³ï¼Œå»ºè­°å…ˆæ‹‰åˆ°è‡³å°‘ 1â€“3 å€‹æœˆã€‚"};
  }

  function updatePreviewAndReport(){
    document.getElementById("reportDate").innerText=todayString();
    const alias=(document.getElementById("clientAlias").value||"").trim();
    document.getElementById("reportAlias").innerText=alias?alias:"ï¼ˆæœªå¡«ï¼‰";

    const income=getMonthlyIncome();
    const exp=getExpenseTotal();
    const remain=income-exp;

    document.getElementById("expenseTotal").innerText=fmt(exp);
    document.getElementById("remainingDisplay").innerText=fmt(remain);

    document.getElementById("reportIncome").innerText=fmt(income);
    document.getElementById("reportExpense").innerText=fmt(exp);
    document.getElementById("reportRemaining").innerText=fmt(remain);

    // housing report
    const ht=document.getElementById("housingType").value;
    const hn=(document.getElementById("housingNote").value||"").trim();
    document.getElementById("reportHousingType").innerText=housingTypeLabel(ht);
    document.getElementById("reportHousingNote").innerText=hn?hn:"â€”";

    // fund
    const fund=getEmergencyFund();
    const fm=getFundMonths();
    const fmDisp=fm?fm.toFixed(1):"0";
    document.getElementById("fundMonths").innerText=fmDisp;
    document.getElementById("reportFund").innerText=fmt(fund);
    document.getElementById("reportFundMonths").innerText=fmDisp;

    const st=fundStatus(fm);
    document.getElementById("fundStatus").innerText=st.label;
    document.getElementById("fundHint").innerText="é å‚™é‡‘æœˆæ•¸ = ç·Šæ€¥é å‚™é‡‘ Ã· æ¯æœˆæ—¥å¸¸é–‹éŠ·åˆè¨ˆï¼ˆå«ä¿è²»ï¼‰\n"+st.msg;
    document.getElementById("reportFundStatus").innerText=st.label;

    // insurance & investment report
    const insM=getInsuranceMonthly();
    const insN=(document.getElementById("insuranceNote").value||"").trim();
    document.getElementById("reportInsMonthly").innerText=fmt(insM);
    document.getElementById("reportInsNote").innerText=insN?insN:"â€”";

    const invM=getInvestmentMonthly();
    const invMeth=(document.getElementById("investmentMethods").value||"").trim();
    document.getElementById("reportInvMonthly").innerText=fmt(invM);
    document.getElementById("reportInvMethods").innerText=invMeth?invMeth:"â€”";

    // plan
    const plan=getPlan();
    document.getElementById("reportPlanText").innerText=plan.text?plan.text:"ï¼ˆæœªå¡«ï¼‰";
    document.getElementById("reportPlanAmount").innerText=fmt(plan.amount);
    document.getElementById("reportPlanYears").innerText=plan.years?`${plan.years} å¹´`:"å°šæœªç¢ºå®š";
  }

  // --- scoring ---
  function scoreSafety(){
    const v=document.getElementById("insuranceStatus").value;
    if(v==="basic") return 3;
    if(v==="partial") return 2;
    return 1;
  }
  function scorePreparation(){
    const remain=getMonthlyIncome()-getExpenseTotal();
    const fm=getFundMonths();
    const plan=getPlan();
    const hasPlanText=!!plan.text;
    const hasPlanNumbers=(plan.amount>0)||(plan.years>0);

    let s=1;
    if(remain>0) s=2;
    if(remain>0 && fm>=3) s=3;
    if(hasPlanText && hasPlanNumbers) s=Math.min(3, s+1);
    return Math.max(1, Math.min(3, s));
  }
  function scoreGrowth(){
    const invM=getInvestmentMonthly();
    const invMeth=(document.getElementById("investmentMethods").value||"").trim();
    if(invM>0 && invMeth) return 3;
    if(invM>0 || invMeth) return 2;
    return 1;
  }

  // --- render final suggestion based on focus + data ---
  function renderNextStep(focus){
    const fm=getFundMonths();
    const st=fundStatus(fm);
    const exp=getExpenseTotal();
    const plan=getPlan();
    const ht=document.getElementById("housingType").value;

    const fundLine = exp>0
      ? `â€¢ é å‚™é‡‘ç´„å¯æ’ ${fm?fm.toFixed(1):"0"} å€‹æœˆï¼ˆ${st.label}ï¼‰`
      : `â€¢ é å‚™é‡‘ç‹€æ…‹ï¼š${st.label}ï¼ˆå…ˆå¡«æ—¥å¸¸é–‹éŠ·æœƒæ›´æº–ï¼‰`;

    const planLine = plan.text
      ? `â€¢ 3â€“5 å¹´è¨ˆç•«ï¼š${plan.text}${plan.amount>0?`ï¼ˆç´„ ${fmt(plan.amount)}ï¼‰`:""}${plan.years>0?`ï¼Œç›®æ¨™ ${plan.years} å¹´ã€‚`:""}`
      : "â€¢ 3â€“5 å¹´è¨ˆç•«ï¼šå°šæœªå¡«ï¼ˆå»ºè­°å…ˆå¯«ç›®æ¨™å…§å®¹ï¼‹å¤§æ¦‚é‡‘é¡ï¼‰";

    const housingLine = (ht==="mortgage") ? "â€¢ æœ‰æˆ¿è²¸ï¼šè²¬ä»»é¢¨éšªå„ªå…ˆï¼ˆé†«ç™‚/æ„å¤–ï¼‹å£½éšªè²¬ä»»ï¼‰" : "";

    const scripts = {
      life: {
        title: "ä½ æœ€åœ¨æ„ï¼šç”Ÿæ´»ä¸ä¸­æ–·",
        steps: [
          "1) å…ˆåšé†«ç™‚ï¼‹æ„å¤–ï¼šæŠŠçªç™¼äº‹ä»¶çš„ã€è‡ªè²»ç¼ºå£ã€è£œèµ·ä¾†",
          "2) é å‚™é‡‘ä¸è¶³æ™‚ï¼šå…ˆæŠŠé å‚™é‡‘æ‹‰åˆ°è‡³å°‘ 1â€“3 å€‹æœˆï¼ˆå†å¾€ 3â€“6 å€‹æœˆï¼‰",
          "3) æœ€å¾Œæ‰è«‡æŠ•è³‡ï¼šå…ˆç©©å®šå†åŠ é€Ÿ"
        ],
        close: "æˆäº¤æ”¶å°¾ï¼šã€æˆ‘å€‘ä»Šå¤©å…ˆæŠŠã€Œä¸ä¸­æ–·ã€åšåˆ°ä½ï¼Œæˆ‘å…ˆåšä¸€å€‹ã€Œæœ€ä½è² æ“”ç‰ˆã€è®“ä½ å…ˆæœ‰åŸºæœ¬é˜²è­·ï¼Œå¯ä»¥å—ï¼Ÿã€"
      },
      family: {
        title: "ä½ æœ€åœ¨æ„ï¼šä¸æ‹–ç´¯å®¶äºº",
        steps: [
          "1) å…ˆåšè²¬ä»»ä¿éšœï¼šå£½éšªè²¬ä»»ï¼‹é‡å¤§é¢¨éšªï¼ˆé†«ç™‚/é‡å¤§å‚·ç—…ç­‰ï¼‰",
          "2) å†è£œé†«ç™‚è‡ªè²»ç¼ºå£ï¼šä½é™¢/æ‰‹è¡“/é•·æœŸæ²»ç™‚",
          "3) æŠ•è³‡æ”¾å¾Œé¢ï¼šå…ˆæŠŠã€å®¶äººä¸è¢«æ‹–ç´¯ã€é€™ä»¶äº‹é–ä½"
        ],
        close: "æˆäº¤æ”¶å°¾ï¼šã€ä½ çš„é‡é»æ˜¯å®¶äººï¼Œæˆ‘å€‘å…ˆæŠŠè²¬ä»»ç¼ºå£è£œä¸Šï¼Œåšåˆ°ã€Œç™¼ç”Ÿäº‹ä¸æœƒæ‹–ç´¯å®¶äººã€ï¼Œæˆ‘å…ˆåšä¸€å€‹ä½ èƒ½æ¥å—çš„æœˆç¹³ç‰ˆæœ¬ï¼Œå¥½å—ï¼Ÿã€"
      },
      future: {
        title: "ä½ æœ€åœ¨æ„ï¼šæœªä¾†è¨ˆç•«ä¸è¢«æ‰“æ–·",
        steps: [
          "1) å…ˆç”¨é¢¨éšªç®¡ç†ä¿è­·è¨ˆç•«ï¼šé†«ç™‚/æ„å¤–ï¼‹é‡å¤§é¢¨éšª",
          "2) å†ç”¨ç¾é‡‘æµè¦åŠƒè¨ˆç•«ï¼šæ¯æœˆå›ºå®šä¸€ç­†åšã€Œè¨ˆç•«åŸºé‡‘ã€",
          "3) æœ€å¾ŒæŠŠæŠ•è³‡è®Šæˆç¿’æ…£ï¼šç”¨å®šæœŸå®šé¡ç¶ä½é•·æœŸç›®æ¨™"
        ],
        close: "æˆäº¤æ”¶å°¾ï¼šã€ä½ æœ€åœ¨æ„çš„æ˜¯è¨ˆç•«ï¼Œæˆ‘å€‘å…ˆç”¨ä¿éšœæŠŠè¨ˆç•«ã€Œä¿ä½ã€ï¼Œå†ç”¨æ¯æœˆå›ºå®šé‡‘é¡æŠŠè¨ˆç•«ã€Œåšå‡ºä¾†ã€ï¼Œæˆ‘åšå…©å€‹ç‰ˆæœ¬ä½ é¸ä¸€å€‹ï¼Œå¥½å—ï¼Ÿã€"
      }
    };

    const s = scripts[focus] || scripts.life;

    const lines = [
      s.title,
      "",
      "çµæ§‹æé†’ï¼š",
      fundLine,
      planLine,
      housingLine,
      "",
      "ä¸‹ä¸€æ­¥å»ºè­°ï¼ˆä¾ä½ é¸çš„å„ªå…ˆé †åºï¼‰ï¼š",
      ...s.steps,
      "",
      s.close
    ].filter(Boolean);

    document.getElementById("nextStep").innerText = lines.join("\n");
  }

  function analyze(){
    updatePreviewAndReport();

    const safety=scoreSafety();
    const prep=scorePreparation();
    const growth=scoreGrowth();

    if(chart) chart.destroy();
    chart=new Chart(document.getElementById("triangleChart"),{
      type:"radar",
      data:{
        labels:["å®‰å…¨","æº–å‚™","æˆé•·"],
        datasets:[{
          data:[safety,prep,growth],
          backgroundColor:"rgba(31,111,255,0.2)",
          borderColor:"#1f6fff",
          borderWidth:2
        }]
      },
      options:{
        maintainAspectRatio:false,
        plugins:{legend:{display:false}},
        scales:{r:{min:0,max:3,ticks:{display:false}}}
      }
    });

    const summaryEl=document.getElementById("summary");

    if(safety===1){
      summaryEl.innerText="ç›®å‰æœ€éœ€è¦å…ˆè™•ç†çš„ä¸æ˜¯æŠ•è³‡ï¼Œè€Œæ˜¯å…ˆæŠŠåŸºæœ¬ä¿éšœèˆ‡é¢¨éšªè£œèµ·ä¾†ï¼Œé¿å…ä¸€æ¬¡äº‹ä»¶è®“ç¾é‡‘æµæ–·æ‰ã€‚";
    }else if(prep===1){
      summaryEl.innerText="ä½ ç¾åœ¨çš„é—œéµæ˜¯æŠŠç·Šæ€¥é å‚™é‡‘æ‹‰èµ·ä¾†ï¼Œè®“äººç”Ÿè¨ˆç•«ä¸æœƒè¢«çªç™¼äº‹ä»¶æ‰“æ–·ã€‚";
    }else{
      summaryEl.innerText="ä½ çš„è²¡å‹™çµæ§‹å·²æœ‰åŸºç¤ï¼Œå¯ä»¥ä¸€æ­¥ä¸€æ­¥å®Œæˆï¼šå…ˆç©©å®šé¢¨éšªèˆ‡é å‚™é‡‘ï¼Œå†æ¨é€²è¨ˆç•«èˆ‡æŠ•è³‡ã€‚";
    }

    // ä¾ç›®å‰ focus ç”¢ç”Ÿæœ€å¾Œå»ºè­°
    renderNextStep(currentFocus);

    // æ¸…ç©º focus æ–‡å­—å€ï¼ˆç”±é¸æ“‡å¾Œå†é¡¯ç¤ºï¼‰
    document.getElementById("focusResult").innerText="";
    document.getElementById("talkCard").innerText="";
  }

  function openModal(){ document.getElementById("modal").style.display="block"; }
  function closeModal(){ document.getElementById("modal").style.display="none"; }

  function selectFocus(type){
    currentFocus = type;
    const focusResultEl=document.getElementById("focusResult");
    const talkCardEl=document.getElementById("talkCard");

    const map = {
      life: "ä½ é¸æ“‡çš„æ˜¯ï¼šç”Ÿæ´»ä¸ä¸­æ–·ï¼ˆä»Šå¤©å…ˆæŠŠé¢¨éšªç¼ºå£è£œèµ·ä¾†ï¼Œç¢ºä¿ç¾é‡‘æµä¸ä¸­æ–·ï¼‰ã€‚",
      family: "ä½ é¸æ“‡çš„æ˜¯ï¼šä¸æ‹–ç´¯å®¶äººï¼ˆä»Šå¤©å…ˆæŠŠè²¬ä»»ç¼ºå£è£œèµ·ä¾†ï¼Œé–ä½å®¶äººçš„å®‰å…¨æ„Ÿï¼‰ã€‚",
      future: "ä½ é¸æ“‡çš„æ˜¯ï¼šæœªä¾†è¨ˆç•«ä¸è¢«æ‰“æ–·ï¼ˆä»Šå¤©å…ˆä¿ä½è¨ˆç•«ï¼Œå†ç”¨å›ºå®šé‡‘é¡æŠŠè¨ˆç•«åšå‡ºä¾†ï¼‰ã€‚"
    };

    focusResultEl.innerText = map[type] || map.life;
    talkCardEl.innerText = focusResultEl.innerText;

    // é‡æ–°ç”¢ç”Ÿã€Œæœ€å¾Œå»ºè­°ã€
    renderNextStep(currentFocus);
  }

  async function downloadPDF(){
    const summaryText=(document.getElementById("summary").innerText||"").trim();
    if(!summaryText){
      alert("è«‹å…ˆæŒ‰ã€Œåˆ†ææˆ‘çš„ç†è²¡é‡‘ä¸‰è§’ã€ç”¢ç”Ÿå ±å‘Šå…§å®¹ï¼Œå†ä¸‹è¼‰ PDFã€‚");
      return;
    }

    updatePreviewAndReport();

    // å°‡ radar canvas è½‰ imgï¼ˆé¿å… PDF æ¼åœ–ï¼‰
    const canvas=document.getElementById("triangleChart");
    const dataUrl=canvas.toDataURL("image/png",1.0);
    const img=document.createElement("img");
    img.src=dataUrl;
    img.style.width="100%";
    img.style.maxWidth="360px";
    img.style.display="block";
    img.style.margin="0 auto";

    const wrapper=canvas.parentElement;
    const backup=canvas.style.display;
    canvas.style.display="none";
    wrapper.appendChild(img);

    // ç­‰ DOM æ›´æ–°
    await new Promise(r=>requestAnimationFrame(r));

    const reportEl=document.getElementById("report");
    const canvasShot = await html2canvas(reportEl, {
      scale: 2,
      backgroundColor: "#ffffff",
      useCORS: true,
      scrollY: -window.scrollY
    });

    // é‚„åŸ
    img.remove();
    canvas.style.display=backup||"block";

    const imgData = canvasShot.toDataURL("image/jpeg", 0.95);
    const { jsPDF } = window.jspdf;

    const pdf = new jsPDF("p","mm","a4");
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();

    const imgWidth = pageWidth;
    const imgHeight = canvasShot.height * imgWidth / canvasShot.width;

    let heightLeft = imgHeight;
    let position = 0;

    pdf.addImage(imgData,"JPEG",0,position,imgWidth,imgHeight);
    heightLeft -= pageHeight;

    while(heightLeft > 0){
      position = heightLeft - imgHeight;
      pdf.addPage();
      pdf.addImage(imgData,"JPEG",0,position,imgWidth,imgHeight);
      heightLeft -= pageHeight;
    }

    const alias=(document.getElementById("clientAlias").value||"").trim();
    const filenameBase=alias?`ç†è²¡é‡‘ä¸‰è§’_çµæ§‹æª¢è¦–å ±å‘Š_${alias}`:"ç†è²¡é‡‘ä¸‰è§’_çµæ§‹æª¢è¦–å ±å‘Š";
    pdf.save(`${filenameBase}.pdf`);
  }

  function resetAll(){
    document.getElementById("clientAlias").value="";
    document.getElementById("incomeType").value="month";
    document.getElementById("incomeAmount").value="";

    document.getElementById("housingType").value="rent";
    document.getElementById("housingNote").value="";

    ["exp_housing","exp_carloan","exp_utilities","exp_food","exp_transport","exp_kids","exp_lifestyle","exp_other"].forEach(id=>{
      document.getElementById(id).value="";
    });

    document.getElementById("insuranceMonthly").value="";
    document.getElementById("insuranceNote").value="";

    document.getElementById("emergencyFund").value="";
    document.getElementById("planText").value="";
    document.getElementById("planAmount").value="";
    document.getElementById("planYears").value="0";

    document.getElementById("investmentMonthly").value="";
    document.getElementById("investmentMethods").value="";
    document.getElementById("insuranceStatus").value="none";

    document.getElementById("summary").innerText="";
    document.getElementById("focusResult").innerText="";
    document.getElementById("talkCard").innerText="";
    document.getElementById("nextStep").innerText="";

    currentFocus="life";
    closeModal();

    if(chart){ chart.destroy(); chart=null; }

    document.getElementById("incomeLabel").innerText="æœˆæ”¶å…¥";
    document.getElementById("reportDate").innerText=todayString();
    updatePreviewAndReport();
    document.getElementById("incomeAmount").focus();
  }

  document.addEventListener("DOMContentLoaded",()=>{
    document.getElementById("reportDate").innerText=todayString();

    const incomeTypeEl=document.getElementById("incomeType");
    const incomeLabelEl=document.getElementById("incomeLabel");
    function syncIncomeLabel(){
      incomeLabelEl.innerText=incomeTypeEl.value==="year"?"å¹´æ”¶å…¥":"æœˆæ”¶å…¥";
      updatePreviewAndReport();
    }
    incomeTypeEl.addEventListener("change",syncIncomeLabel);

    // realtime preview
    const watchIds=[
      "clientAlias","incomeAmount","housingType","housingNote",
      "exp_housing","exp_carloan","exp_utilities","exp_food","exp_transport","exp_kids","exp_lifestyle","exp_other",
      "insuranceMonthly","insuranceNote",
      "emergencyFund","planText","planAmount","planYears",
      "investmentMonthly","investmentMethods","insuranceStatus"
    ];
    watchIds.forEach(id=>{
      const el=document.getElementById(id);
      if(!el) return;
      el.addEventListener(el.tagName==="SELECT" ? "change" : "input", updatePreviewAndReport);
    });

    document.getElementById("btnAnalyze").addEventListener("click",analyze);
    document.getElementById("btnOpenModal").addEventListener("click",openModal);
    document.getElementById("btnCloseModal").addEventListener("click",closeModal);
    document.getElementById("btnPDF").addEventListener("click",downloadPDF);
    document.getElementById("btnReset").addEventListener("click",resetAll);

    document.querySelectorAll(".option-btn").forEach(btn=>{
      btn.addEventListener("click",()=>selectFocus(btn.dataset.focus));
    });

    syncIncomeLabel();
    updatePreviewAndReport();
  });
</script>
</body>
</html>
