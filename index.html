<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ç†è²¡é‡‘ä¸‰è§’ï½œç¾å ´æˆäº¤ç‰ˆ</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- PDF: html2canvas + jsPDFï¼ˆé¿å… html2pdf ç©ºç™½ï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    body{font-family:system-ui,-apple-system,BlinkMacSystemFont;background:#f7f8fa;margin:0;padding:16px}
    h1{text-align:center;margin:0 0 6px}
    .subtitle{text-align:center;color:#555;margin:0}
    .desc{text-align:center;color:#888;font-size:14px;margin:8px 0 12px}
    .card{background:#fff;border-radius:12px;padding:16px;margin-bottom:16px;box-shadow:0 2px 8px rgba(0,0,0,.05)}
    label{display:block;margin-top:12px;font-weight:900}
    .sub-label{font-weight:700;margin-top:10px;color:#333}
    .hint{font-size:13px;color:#666;margin-top:8px;line-height:1.5;white-space:pre-line}
    input,select,textarea{width:100%;padding:10px;margin-top:6px;font-size:16px;box-sizing:border-box}
    textarea{min-height:72px;resize:vertical}
    button{width:100%;padding:14px;font-size:18px;border:none;border-radius:8px;margin-top:12px;cursor:pointer}
    .primary{background:#1f6fff;color:#fff}
    .cta{background:#e53935;color:#fff}
    .secondary{background:#4caf50;color:#fff}
    .reset{background:#9e9e9e;color:#fff}

    .result{font-size:18px;line-height:1.6;margin-top:12px;white-space:pre-line}
    .calc-box{margin-top:12px;padding:12px;border-radius:10px;background:#f2f6ff}
    .calc-title{font-weight:1000;margin-bottom:6px}
    .calc-row{display:flex;justify-content:space-between;gap:12px}
    .calc-row span{font-weight:1000}
    .status-chip{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:900;font-size:13px;background:#eee;color:#333;margin-top:8px}

    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:720px){ .grid-2{grid-template-columns:1fr} }

    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:999}
    .modal-content{background:#fff;margin:8% auto;padding:18px;border-radius:12px;width:92%;max-width:520px}
    .option-btn{width:100%;padding:12px;border-radius:8px;border:1px solid #ccc;background:#f7f7f7;margin-top:8px;font-size:16px;cursor:pointer}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#f1f5ff;border:1px solid #d7e4ff;font-weight:900;margin-top:8px}

    #reportHeader{margin-bottom:10px;padding-bottom:10px;border-bottom:1px solid #eee}
    .report-title{font-size:20px;font-weight:1000;margin:0}
    .report-sub{color:#555;margin:4px 0 0}
    .report-meta{color:#777;font-size:13px;margin-top:8px;line-height:1.5}
    .small-note{font-size:13px;color:#777;margin-top:12px}

    .two-col{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:720px){ .two-col{grid-template-columns:1fr} }

    .card-mini{background:#fafafa;border:1px solid #eee;border-radius:10px;padding:12px;margin-top:10px}
    .card-mini-title{font-weight:1000;margin:0 0 6px}
    .tag{display:inline-block;font-size:12px;font-weight:900;padding:4px 8px;border-radius:999px;background:#eee;margin-top:6px}
    .tag.good{background:#e7f7ee}
    .tag.warn{background:#fff2df}
    .tag.bad{background:#ffe6e6}
  </style>
</head>

<body>
  <h1>ç†è²¡é‡‘ä¸‰è§’</h1>
  <div class="subtitle">ç¾å ´æˆäº¤ç‰ˆï¼šè²¡å‹™çµæ§‹æª¢è¦–</div>
  <div class="desc">å¡«å¯« â†’ åˆ†æ â†’ é¸å®¢æˆ¶æœ€é‡è¦– â†’ äºŒé¸ä¸€ç‰ˆæœ¬ â†’ é¡¯ç¤ºæˆäº¤è©±è¡“å°å¡ â†’ å¯ä¸‹è¼‰PDF</div>

  <!-- Input -->
  <div class="card">
    <label>å®¢æˆ¶ä»£ç¨±ï¼ˆé¸å¡«ï¼‰</label>
    <input type="text" id="clientAlias" placeholder="ä¾‹å¦‚ï¼šç‹å…ˆç”Ÿ / é™³å°å§ / Aå®¢ï¼ˆé¿å…å¡«èº«åˆ†è­‰ã€é›»è©±ç­‰å€‹è³‡ï¼‰" />

    <label>å¹´é½¡</label>
    <input type="number" id="clientAge" placeholder="ä¾‹å¦‚ï¼š28" inputmode="numeric"/>

    <label>æ”¶å…¥è¼¸å…¥æ–¹å¼</label>
    <select id="incomeType">
      <option value="month">æœˆæ”¶å…¥</option>
      <option value="year">å¹´æ”¶å…¥</option>
    </select>

    <label id="incomeLabel">æœˆæ”¶å…¥</label>
    <input type="number" id="incomeAmount" placeholder="ä¾‹å¦‚ï¼š45000" inputmode="numeric"/>

    <!-- Housing -->
    <label>å±…ä½ç‹€æ³ï¼ˆæˆ¿ç§Ÿ/æˆ¿è²¸ï¼‰</label>
    <div class="grid-2">
      <div>
        <div class="sub-label">ç›®å‰æ˜¯</div>
        <select id="housingType">
          <option value="rent">ç§Ÿå±‹ï¼ˆæˆ¿ç§Ÿï¼‰</option>
          <option value="mortgage">æœ‰æˆ¿è²¸</option>
          <option value="none">ç„¡ï¼ˆå®¶è£¡/å…¬å¸å®¿èˆ/å…æˆ¿ç§Ÿï¼‰</option>
        </select>
      </div>
      <div>
        <div class="sub-label">å‚™è¨»ï¼ˆé¸å¡«ï¼‰</div>
        <input type="text" id="housingNote" placeholder="ä¾‹å¦‚ï¼šè·Ÿå®¶äººåŒä½ / å…±åŒåˆ†æ”¤ / æˆ¿è²¸å‰© 18 å¹´â€¦" />
      </div>
    </div>

    <label>æ—¥å¸¸é–‹éŠ·ï¼ˆæ¯æœˆï¼Œè«‹é€é …å¡«å¯«ï¼‰</label>
    <div class="sub-label">æˆ¿ç§Ÿ/æˆ¿è²¸ï¼ˆä¾ä¸Šæ–¹ç‹€æ³å¡«é‡‘é¡ï¼‰</div>
    <input type="number" id="exp_housing" placeholder="0" inputmode="numeric"/>
    <div class="sub-label">è»Šè²¸</div>
    <input type="number" id="exp_carloan" placeholder="0" inputmode="numeric"/>
    <div class="sub-label">æ°´é›»ç“¦æ–¯/ç¶²è·¯æ‰‹æ©Ÿ</div>
    <input type="number" id="exp_utilities" placeholder="0" inputmode="numeric"/>
    <div class="sub-label">é¤é£²ï¼ˆå¤–é£Ÿ/è²·èœï¼‰</div>
    <input type="number" id="exp_food" placeholder="0" inputmode="numeric"/>
    <div class="sub-label">äº¤é€šï¼ˆé€šå‹¤/æ²¹éŒ¢/åœè»Šï¼‰</div>
    <input type="number" id="exp_transport" placeholder="0" inputmode="numeric"/>
    <div class="sub-label">æ•™è‚²/è‚²å…’ï¼ˆå­¸è²»/æ‰è—/ä¿æ¯ï¼‰</div>
    <input type="number" id="exp_kids" placeholder="0" inputmode="numeric"/>
    <div class="sub-label">å¨›æ¨‚/è³¼ç‰©/ç¤¾äº¤</div>
    <input type="number" id="exp_lifestyle" placeholder="0" inputmode="numeric"/>
    <div class="sub-label">å…¶ä»–å›ºå®šæ”¯å‡º</div>
    <input type="number" id="exp_other" placeholder="0" inputmode="numeric"/>

    <!-- Insurance -->
    <label>ä¿éšªï¼ˆå®¢æˆ¶è‡ªè¡Œå¡«å¯«ï¼‰</label>
    <div class="grid-2">
      <div>
        <div class="sub-label">æ¯æœˆä¿è²»ï¼ˆå¤§ç´„å³å¯ï¼‰</div>
        <input type="number" id="insuranceMonthly" placeholder="ä¾‹å¦‚ï¼š2500" inputmode="numeric"/>
      </div>
      <div>
        <div class="sub-label">å‚™è¨»ï¼ˆé¸å¡«ï¼‰</div>
        <input type="text" id="insuranceNote" placeholder="ä¾‹å¦‚ï¼šåªæœ‰åœ˜ä¿ / ä¸»è¦æ˜¯é†«ç™‚ / å®¶äººå¹«è²·â€¦" />
      </div>
    </div>

    <div class="calc-box">
      <div class="calc-title">ç³»çµ±è¨ˆç®—ï¼ˆç¾é‡‘æµï¼‰</div>
      <div class="calc-row"><div>æ¯æœˆæ—¥å¸¸é–‹éŠ·åˆè¨ˆï¼ˆå«ä¿è²»ï¼‰</div><div><span id="expenseTotal">0</span></div></div>
      <div class="calc-row" style="margin-top:6px;"><div>å¯æ”¯é…æ‰€å¾—ï¼ˆæœˆå‰©é¤˜ï¼‰</div><div><span id="remainingDisplay">0</span></div></div>
      <div class="hint">å¯æ”¯é…æ‰€å¾— = æœˆæ”¶å…¥ï¼ˆæ›ç®—ï¼‰ - æ—¥å¸¸é–‹éŠ·åˆè¨ˆï¼ˆå«ä¿è²»ï¼‰</div>
    </div>

    <!-- Emergency fund -->
    <label>ç·Šæ€¥é å‚™é‡‘ï¼ˆç›®å‰å·²å­˜çš„é‡‘é¡ï¼‰</label>
    <input type="number" id="emergencyFund" placeholder="ä¾‹å¦‚ï¼š120000" inputmode="numeric"/>

    <div class="calc-box" style="background:#f7f7ff;">
      <div class="calc-title">ç³»çµ±è¨ˆç®—ï¼ˆé å‚™é‡‘ï¼‰</div>
      <div class="calc-row"><div>é å‚™é‡‘å¯æ”¯æ’ï¼ˆæœˆï¼‰</div><div><span id="fundMonths">0</span></div></div>
      <div class="calc-row" style="margin-top:6px;"><div>ç‹€æ…‹æç¤º</div><div><span id="fundStatus" class="status-chip">å°šæœªè©•ä¼°</span></div></div>
      <div class="hint" id="fundHint">é å‚™é‡‘æœˆæ•¸ = ç·Šæ€¥é å‚™é‡‘ Ã· æ¯æœˆæ—¥å¸¸é–‹éŠ·åˆè¨ˆï¼ˆå«ä¿è²»ï¼‰</div>
    </div>

    <!-- Plan -->
    <label>3â€“5 å¹´è¨ˆç•«ï¼ˆè«‹å®¢æˆ¶è‡ªå·±å¡«ï¼‰</label>
    <div class="sub-label">è¨ˆç•«å…§å®¹ï¼ˆå¯å¤šé …ï¼‰</div>
    <textarea id="planText" placeholder="ä¾‹å¦‚ï¼šçµå©šã€è²·è»Šã€é€²ä¿®ã€å‡ºåœ‹ã€å‰µæ¥­ã€æˆ¿å±‹é ­æœŸæ¬¾..."></textarea>
    <div class="grid-2">
      <div>
        <div class="sub-label">ç›®æ¨™é‡‘é¡ï¼ˆä¼°è¨ˆå³å¯ï¼‰</div>
        <input type="number" id="planAmount" placeholder="ä¾‹å¦‚ï¼š300000" inputmode="numeric"/>
      </div>
      <div>
        <div class="sub-label">é è¨ˆå¹¾å¹´å®Œæˆï¼ˆ3â€“5 å¹´ï¼‰</div>
        <select id="planYears">
          <option value="0">å°šæœªç¢ºå®š</option>
          <option value="3">3 å¹´</option>
          <option value="4">4 å¹´</option>
          <option value="5">5 å¹´</option>
        </select>
      </div>
    </div>

    <!-- Investment -->
    <label>æŠ•è³‡ï¼ˆå®¢æˆ¶è‡ªè¡Œå¡«å¯«ï¼‰</label>
    <div class="grid-2">
      <div>
        <div class="sub-label">æ¯æœˆæŠ•è³‡é‡‘é¡ï¼ˆå¤§ç´„å³å¯ï¼‰</div>
        <input type="number" id="investmentMonthly" placeholder="ä¾‹å¦‚ï¼š3000" inputmode="numeric"/>
      </div>
      <div>
        <div class="sub-label">æŠ•è³‡æ–¹å¼ï¼ˆå¯å¤šé¸ï¼Œæˆ–å‚™è¨»ï¼‰</div>
        <input type="text" id="investmentMethods" placeholder="ä¾‹å¦‚ï¼šå®šæœŸå®šé¡ETF/åŸºé‡‘/è‚¡ç¥¨/å„²è“„/åŠ å¯†/å…¶ä»–â€¦" />
      </div>
    </div>

    <!-- Protection self-check -->
    <label>ä¿éšœè‡ªè©•ï¼ˆåªç”¨æ–¼çµæ§‹åˆ¤è®€ï¼‰</label>
    <select id="insuranceStatus">
      <option value="none">æ²’æœ‰/å¾ˆå°‘</option>
      <option value="partial">æœ‰ä½†ä¸å®Œæ•´</option>
      <option value="basic">è¦ºå¾—åŸºæœ¬ä¿éšœå®Œæ•´</option>
    </select>

    <button class="primary" id="btnAnalyze" type="button">åˆ†ææˆ‘çš„ç†è²¡é‡‘ä¸‰è§’</button>
  </div>

  <!-- Report -->
  <div class="card" id="report">
    <div id="reportHeader">
      <p class="report-title">ç†è²¡é‡‘ä¸‰è§’ï½œè²¡å‹™çµæ§‹æª¢è¦–å ±å‘Š</p>
      <p class="report-sub">ç†è²¡ Ã— ä¿éšœ Ã— ç·Šæ€¥é å‚™é‡‘ï¼ˆåªçœ‹çµæ§‹ï¼Œä¸è«‡å ±é…¬ï¼‰</p>
      <div class="report-meta">
        <div>æ—¥æœŸï¼š<span id="reportDate"></span></div>
        <div>å®¢æˆ¶ä»£ç¨±ï¼š<span id="reportAlias">ï¼ˆæœªå¡«ï¼‰</span></div>
        <div>å¹´é½¡ï¼š<span id="reportAge">â€”</span></div>
      </div>
    </div>

    <div class="calc-box" style="background:#f7f7ff;">
      <div class="calc-title">ç¾æ³æ‘˜è¦ï¼ˆæ¯æœˆï¼‰</div>
      <div class="calc-row"><div>æœˆæ”¶å…¥ï¼ˆæ›ç®—ï¼‰</div><div><span id="reportIncome">0</span></div></div>
      <div class="calc-row" style="margin-top:6px;"><div>æ—¥å¸¸é–‹éŠ·åˆè¨ˆï¼ˆå«ä¿è²»ï¼‰</div><div><span id="reportExpense">0</span></div></div>
      <div class="calc-row" style="margin-top:6px;"><div>å¯æ”¯é…æ‰€å¾—ï¼ˆæœˆå‰©é¤˜ï¼‰</div><div><span id="reportRemaining">0</span></div></div>

      <div class="calc-row" style="margin-top:6px;"><div>æˆ¿ç§Ÿ/æˆ¿è²¸ç‹€æ³</div><div><span id="reportHousingType">â€”</span></div></div>
      <div class="calc-row" style="margin-top:6px;"><div>å‚™è¨»</div><div><span id="reportHousingNote">â€”</span></div></div>

      <div class="calc-row" style="margin-top:6px;"><div>ç·Šæ€¥é å‚™é‡‘</div><div><span id="reportFund">0</span></div></div>
      <div class="calc-row" style="margin-top:6px;"><div>é å‚™é‡‘å¯æ”¯æ’ï¼ˆæœˆï¼‰</div><div><span id="reportFundMonths">0</span></div></div>
      <div class="calc-row" style="margin-top:6px;"><div>é å‚™é‡‘ç‹€æ…‹</div><div><span id="reportFundStatus">å°šæœªè©•ä¼°</span></div></div>

      <div class="calc-row" style="margin-top:6px;"><div>æ¯æœˆä¿è²»ï¼ˆå®¢æˆ¶å¡«ï¼‰</div><div><span id="reportInsMonthly">0</span></div></div>
      <div class="calc-row" style="margin-top:6px;"><div>ä¿éšªå‚™è¨»</div><div><span id="reportInsNote">â€”</span></div></div>

      <div class="calc-row" style="margin-top:6px;"><div>æ¯æœˆæŠ•è³‡é‡‘é¡ï¼ˆå®¢æˆ¶å¡«ï¼‰</div><div><span id="reportInvMonthly">0</span></div></div>
      <div class="calc-row" style="margin-top:6px;"><div>æŠ•è³‡æ–¹å¼ï¼ˆå®¢æˆ¶å¡«ï¼‰</div><div><span id="reportInvMethods">â€”</span></div></div>
    </div>

    <div class="calc-box" style="background:#fff7f2;">
      <div class="calc-title">3â€“5 å¹´è¨ˆç•«</div>
      <div class="hint" style="margin-top:0;">
        å…§å®¹ï¼š<span id="reportPlanText">ï¼ˆæœªå¡«ï¼‰</span><br/>
        ç›®æ¨™é‡‘é¡ï¼š<span id="reportPlanAmount">0</span><br/>
        å¹´é™ï¼š<span id="reportPlanYears">å°šæœªç¢ºå®š</span>
      </div>
    </div>

    <div style="max-width:360px;margin:0 auto;">
      <canvas id="triangleChart" height="260"></canvas>
    </div>

    <div id="summary" class="result"></div>
    <div id="focusResult" class="result"></div>

    <div class="card-mini" id="dealBox" style="display:none;">
      <p class="card-mini-title">æˆäº¤è©±è¡“å°å¡</p>
      <div class="pill" id="dealPill">ç‰ˆæœ¬ï¼šâ€”</div>
      <div class="hint" id="dealScript" style="margin-top:10px;"></div>
    </div>

    <div id="nextStep" class="result" style="background:#f7f7ff;padding:12px;border-radius:10px;"></div>

    <p class="small-note">
      æœ¬å ±å‘Šåƒ…ç‚ºè²¡å‹™çµæ§‹æª¢è¦–ï¼Œä¸æ¶‰åŠæŠ•è³‡å ±é…¬ã€æ”¶ç›Šæ‰¿è«¾æˆ–ç‰¹å®šå•†å“æ¨è–¦ã€‚
      å¾ŒçºŒè¦åŠƒå°‡ä»¥é¢è«‡ç¢ºèªéœ€æ±‚èˆ‡å¯è² æ“”æ€§ç‚ºæº–ã€‚
    </p>
  </div>

  <button class="cta" id="btnOpenFocus" type="button">æˆäº¤æŒ‰éˆ•ï¼šå…ˆé¸å®¢æˆ¶æœ€é‡è¦–çš„</button>
  <button class="secondary" id="btnPDF" type="button">ä¸‹è¼‰æœ¬æ¬¡åˆ†æå ±å‘Šï¼ˆPDFï¼‰</button>
  <button class="reset" id="btnReset" type="button">é‡è¨­ï¼ä¸‹ä¸€ä½å®¢æˆ¶</button>

  <!-- Focus Modal -->
  <div id="focusModal" class="modal">
    <div class="modal-content">
      <h3 style="margin:0 0 8px;">å¦‚æœåªèƒ½å…ˆé¡§å¥½ä¸€ä»¶äº‹ï¼Œä½ ç¾åœ¨æœ€åœ¨æ„å“ªä¸€å¡Šï¼Ÿ</h3>
      <button class="option-btn" type="button" data-focus="life">ç”Ÿæ´»ä¸ä¸­æ–·</button>
      <button class="option-btn" type="button" data-focus="family">ä¸æ‹–ç´¯å®¶äºº</button>
      <button class="option-btn" type="button" data-focus="future">æœªä¾†è¨ˆç•«ä¸è¢«æ‰“æ–·</button>
      <p id="focusTalk" style="margin-top:12px;line-height:1.6;"></p>
      <button class="primary" id="btnToDeal" type="button">ä¸‹ä¸€æ­¥ï¼šäºŒé¸ä¸€ç‰ˆæœ¬</button>
      <button class="reset" id="btnCloseFocus" type="button">å…ˆä¸è¦</button>
    </div>
  </div>

  <!-- Deal Modal (A/B) -->
  <div id="dealModal" class="modal">
    <div class="modal-content">
      <h3 style="margin:0 0 8px;">äºŒé¸ä¸€ï¼šä½ è¦å…ˆåšå“ªå€‹ç‰ˆæœ¬ï¼Ÿ</h3>
      <div class="hint">å»ºè­°åšæ³•ï¼šå…ˆç”¨ A ä½è² æ“”å…ˆå¡ä½ï¼Œè®“å®¢æˆ¶ã€Œå…ˆæœ‰é˜²è­·ã€ã€‚é¡˜æ„çš„å®¢æˆ¶å†åš B å®Œæ•´åˆ°ä½ã€‚</div>

      <button class="option-btn" type="button" data-deal="A">
        Aï½œä½è² æ“”å…ˆå¡ä½ï¼ˆå…ˆæˆäº¤ï¼‰
        <div class="hint">å…ˆæŠŠã€Œæœ€é‡è¦é‚£ä¸€å¡Šã€åšåˆ°ä½ï¼Œæˆæœ¬æœ€ä½ã€é€Ÿåº¦æœ€å¿«ã€‚</div>
      </button>

      <button class="option-btn" type="button" data-deal="B">
        Bï½œå®Œæ•´åˆ°ä½ï¼ˆä¸€æ¬¡è£œé½Šï¼‰
        <div class="hint">ä¸€æ¬¡æŠŠç¼ºå£è£œé½Šï¼Œçµæ§‹æ›´å®Œæ•´ã€å¾ŒçºŒæ›´çœå¿ƒã€‚</div>
      </button>

      <button class="primary" id="btnCloseDeal" type="button">å¥—ç”¨ä¸¦é—œé–‰</button>
    </div>
  </div>

<script>
  let chart=null;

  // Focus + Deal choice
  let currentFocus="life";   // life | family | future
  let currentDeal="A";       // A | B

  const n=v=>Number(v||0);
  const fmt=v=>Math.round(Number(v||0)).toLocaleString("zh-Hant-TW");

  function todayString(){
    const d=new Date();
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
  }

  function getAge(){ return Number(document.getElementById("clientAge").value || 0); }
  function ageStage(age){
    if(age<=0) return "";
    if(age<30) return "ï¼ˆèµ·æ­¥æœŸï¼‰";
    if(age<40) return "ï¼ˆç´¯ç©æœŸï¼‰";
    if(age<50) return "ï¼ˆè²¬ä»»é«˜å³°æœŸï¼‰";
    return "ï¼ˆç©©å®šï¼è½‰æ›æœŸï¼‰";
  }

  function getMonthlyIncome(){
    const t=document.getElementById("incomeType").value;
    const a=n(document.getElementById("incomeAmount").value);
    return t==="year"?a/12:a;
  }

  function getInsuranceMonthly(){ return n(document.getElementById("insuranceMonthly").value); }
  function getInvestmentMonthly(){ return n(document.getElementById("investmentMonthly").value); }

  function getExpenseTotal(){
    const ids=["exp_housing","exp_carloan","exp_utilities","exp_food","exp_transport","exp_kids","exp_lifestyle","exp_other"];
    const base=ids.reduce((s,id)=>s+n(document.getElementById(id).value),0);
    return base + getInsuranceMonthly(); // ä¿è²»ç®—é€²é–‹éŠ·
  }

  function getEmergencyFund(){ return n(document.getElementById("emergencyFund").value); }
  function getFundMonths(){
    const exp=getExpenseTotal();
    const fund=getEmergencyFund();
    if(exp<=0) return 0;
    return fund/exp;
  }

  function getPlan(){
    return {
      text:(document.getElementById("planText").value||"").trim(),
      amount:n(document.getElementById("planAmount").value),
      years:n(document.getElementById("planYears").value)
    };
  }

  function housingTypeLabel(v){
    if(v==="rent") return "ç§Ÿå±‹ï¼ˆæˆ¿ç§Ÿï¼‰";
    if(v==="mortgage") return "æœ‰æˆ¿è²¸";
    return "ç„¡ï¼ˆå…æˆ¿ç§Ÿï¼‰";
  }

  // Single thresholds (no student/worker)
  function fundStatus(fm){
    if(fm>=6) return {label:"å¾ˆç©© âœ…", msg:"é å‚™é‡‘ â‰¥6 å€‹æœˆï¼šç¾é‡‘æµé‡åˆ°è®Šå‹•ä¹Ÿæ¯”è¼ƒæ‰›å¾—ä½ã€‚", level:"good"};
    if(fm>=3) return {label:"è¶³å¤  ğŸ‘", msg:"é å‚™é‡‘ 3â€“6 å€‹æœˆï¼šåŸºæœ¬å®‰å…¨é‚Šéš›ä¸éŒ¯ã€‚", level:"good"};
    if(fm>=1) return {label:"å°šå¯ âš ï¸", msg:"é å‚™é‡‘ 1â€“3 å€‹æœˆï¼šå°šå¯ï¼Œä½†æ”¶å…¥ä¸­æ–·æ™‚å£“åŠ›æœƒä¸Šä¾†ã€‚", level:"warn"};
    return {label:"ä¸è¶³ â—", msg:"é å‚™é‡‘ <1 å€‹æœˆï¼šåä¸è¶³ï¼Œå»ºè­°å…ˆæ‹‰åˆ°è‡³å°‘ 1â€“3 å€‹æœˆã€‚", level:"bad"};
  }

  function updatePreviewAndReport(){
    document.getElementById("reportDate").innerText=todayString();
    const alias=(document.getElementById("clientAlias").value||"").trim();
    document.getElementById("reportAlias").innerText=alias?alias:"ï¼ˆæœªå¡«ï¼‰";

    const age=getAge();
    document.getElementById("reportAge").innerText = age ? `${age} æ­² ${ageStage(age)}` : "â€”";

    const income=getMonthlyIncome();
    const exp=getExpenseTotal();
    const remain=income-exp;

    document.getElementById("expenseTotal").innerText=fmt(exp);
    document.getElementById("remainingDisplay").innerText=fmt(remain);

    document.getElementById("reportIncome").innerText=fmt(income);
    document.getElementById("reportExpense").innerText=fmt(exp);
    document.getElementById("reportRemaining").innerText=fmt(remain);

    // housing
    const ht=document.getElementById("housingType").value;
    const hn=(document.getElementById("housingNote").value||"").trim();
    document.getElementById("reportHousingType").innerText=housingTypeLabel(ht);
    document.getElementById("reportHousingNote").innerText=hn?hn:"â€”";

    // fund
    const fund=getEmergencyFund();
    const fm=getFundMonths();
    const fmDisp=fm?fm.toFixed(1):"0";
    document.getElementById("fundMonths").innerText=fmDisp;
    document.getElementById("reportFund").innerText=fmt(fund);
    document.getElementById("reportFundMonths").innerText=fmDisp;

    const st=fundStatus(fm);
    document.getElementById("fundStatus").innerText=st.label;
    document.getElementById("fundHint").innerText="é å‚™é‡‘æœˆæ•¸ = ç·Šæ€¥é å‚™é‡‘ Ã· æ¯æœˆæ—¥å¸¸é–‹éŠ·åˆè¨ˆï¼ˆå«ä¿è²»ï¼‰\n"+st.msg;
    document.getElementById("reportFundStatus").innerText=st.label;

    // insurance & investment
    const insM=getInsuranceMonthly();
    const insN=(document.getElementById("insuranceNote").value||"").trim();
    document.getElementById("reportInsMonthly").innerText=fmt(insM);
    document.getElementById("reportInsNote").innerText=insN?insN:"â€”";

    const invM=getInvestmentMonthly();
    const invMeth=(document.getElementById("investmentMethods").value||"").trim();
    document.getElementById("reportInvMonthly").innerText=fmt(invM);
    document.getElementById("reportInvMethods").innerText=invMeth?invMeth:"â€”";

    // plan
    const plan=getPlan();
    document.getElementById("reportPlanText").innerText=plan.text?plan.text:"ï¼ˆæœªå¡«ï¼‰";
    document.getElementById("reportPlanAmount").innerText=fmt(plan.amount);
    document.getElementById("reportPlanYears").innerText=plan.years?`${plan.years} å¹´`:"å°šæœªç¢ºå®š";
  }

  // -------- Radar axis scoring (Finance, Protection, Emergency Fund) ----------
  function scoreProtection(){ // ä¿éšœ
    const v=document.getElementById("insuranceStatus").value;
    if(v==="basic") return 3;
    if(v==="partial") return 2;
    return 1;
  }

  function scoreEmergencyFund(){ // ç·Šæ€¥é å‚™é‡‘
    const fm=getFundMonths();
    if(fm>=3) return 3;
    if(fm>=1) return 2;
    return 1;
  }

  function scoreFinance(){ // ç†è²¡ï¼ˆç¾é‡‘æµ + æŠ•è³‡ç¿’æ…£ï¼‰
    const remain=getMonthlyIncome()-getExpenseTotal();
    const inv=getInvestmentMonthly();
    if(remain<=0) return 1;
    if(inv>0) return 3;
    return 2;
  }

  // -------- Suggestions engine ----------
  function focusLabel(f){
    if(f==="family") return "ä¸æ‹–ç´¯å®¶äºº";
    if(f==="future") return "æœªä¾†è¨ˆç•«ä¸è¢«æ‰“æ–·";
    return "ç”Ÿæ´»ä¸ä¸­æ–·";
  }

  function focusExplain(f){
    const map={
      life:"ä½ é¸æ“‡çš„æ˜¯ï¼šç”Ÿæ´»ä¸ä¸­æ–·ï¼ˆä»Šå¤©å…ˆæŠŠçªç™¼äº‹ä»¶é€ æˆçš„ç¼ºå£è£œèµ·ä¾†ï¼Œç¢ºä¿ç¾é‡‘æµä¸ä¸­æ–·ï¼‰ã€‚",
      family:"ä½ é¸æ“‡çš„æ˜¯ï¼šä¸æ‹–ç´¯å®¶äººï¼ˆä»Šå¤©å…ˆæŠŠè²¬ä»»ç¼ºå£è£œèµ·ä¾†ï¼Œé–ä½å®¶äººçš„å®‰å…¨æ„Ÿï¼‰ã€‚",
      future:"ä½ é¸æ“‡çš„æ˜¯ï¼šæœªä¾†è¨ˆç•«ä¸è¢«æ‰“æ–·ï¼ˆä»Šå¤©å…ˆä¿ä½è¨ˆç•«ï¼Œå†ç”¨å›ºå®šé‡‘é¡æŠŠè¨ˆç•«åšå‡ºä¾†ï¼‰ã€‚"
    };
    return map[f] || map.life;
  }

  function dealLabel(d){ return d==="B" ? "Bï½œå®Œæ•´åˆ°ä½" : "Aï½œä½è² æ“”å…ˆå¡ä½"; }

  function renderNextStep(){
    const age=getAge();
    const fm=getFundMonths();
    const st=fundStatus(fm);
    const exp=getExpenseTotal();
    const plan=getPlan();
    const ht=document.getElementById("housingType").value;

    const income=getMonthlyIncome();
    const remain=income-exp;

    const ageLine = age ? `â€¢ å¹´é½¡ï¼š${age} æ­² ${ageStage(age)}ï¼ˆå»ºè­°æœƒä¾äººç”Ÿéšæ®µèª¿æ•´å„ªå…ˆé †åºï¼‰` : "";
    const fundLine = exp>0
      ? `â€¢ é å‚™é‡‘ç´„å¯æ’ ${fm?fm.toFixed(1):"0"} å€‹æœˆï¼ˆ${st.label}ï¼‰`
      : `â€¢ é å‚™é‡‘ç‹€æ…‹ï¼š${st.label}ï¼ˆå…ˆå¡«æ—¥å¸¸é–‹éŠ·æœƒæ›´æº–ï¼‰`;

    const planLine = plan.text
      ? `â€¢ 3â€“5 å¹´è¨ˆç•«ï¼š${plan.text}${plan.amount>0?`ï¼ˆç´„ ${fmt(plan.amount)}ï¼‰`:""}${plan.years>0?`ï¼Œç›®æ¨™ ${plan.years} å¹´ã€‚`:""}`
      : "â€¢ 3â€“5 å¹´è¨ˆç•«ï¼šå°šæœªå¡«ï¼ˆå»ºè­°å…ˆå¯«ç›®æ¨™å…§å®¹ï¼‹å¤§æ¦‚é‡‘é¡ï¼‰";

    const housingLine = (ht==="mortgage") ? "â€¢ æœ‰æˆ¿è²¸ï¼šè²¬ä»»é¢¨éšªå„ªå…ˆï¼ˆé†«ç™‚/æ„å¤–ï¼‹è²¬ä»»å‹ä¿éšœï¼‰" : "";
    const cashLine = `â€¢ å¯æ”¯é…æ‰€å¾—ï¼ˆæœˆå‰©é¤˜ï¼‰ï¼š${fmt(remain)}ï¼ˆå‰©é¤˜è¶Šç©©ï¼Œè¶Šå¥½åšé å‚™é‡‘èˆ‡ç†è²¡ï¼‰`;

    const base = [
      `ä½ æœ€åœ¨æ„ï¼š${focusLabel(currentFocus)}`,
      `ä½ é¸æ“‡ç‰ˆæœ¬ï¼š${dealLabel(currentDeal)}`,
      "",
      "çµæ§‹æé†’ï¼š",
      ageLine,
      cashLine,
      fundLine,
      planLine,
      housingLine,
      ""
    ].filter(Boolean);

    const scripts = {
      life: {
        A: {
          steps:[
            "1) å…ˆåšé†«ç™‚ï¼‹æ„å¤–ï¼šæŠŠçªç™¼äº‹ä»¶çš„ã€è‡ªè²»ç¼ºå£ã€è£œèµ·ä¾†",
            "2) é å‚™é‡‘ä¸è¶³ï¼šç”¨å¯æ”¯é…æ‰€å¾—å…ˆæ‹‰åˆ°è‡³å°‘ 1â€“3 å€‹æœˆ",
            "3) æŠ•è³‡å¾Œé¢å†èªªï¼šå…ˆç©©å®šå†åŠ é€Ÿ"
          ],
          close:"ã€å…ˆæŠŠã€Œä¸ä¸­æ–·æ”¶å…¥ã€åšåˆ°ä½ï¼Œå…ˆè¦åŠƒã€Œæœ€åŸºæœ¬ç‰ˆã€ï¼Œå…ˆæœ‰åŸºæœ¬é˜²è­·ã€"
        },
        B: {
          steps:[
            "1) é†«ç™‚ï¼‹æ„å¤–ä¸€æ¬¡åˆ°ä½ï¼šæŠŠå¸¸è¦‹çªç™¼é¢¨éšªçš„ç¼ºå£è£œé½Š",
            "2) é å‚™é‡‘æ‹‰åˆ° 3â€“6 å€‹æœˆï¼šè®“ç¾é‡‘æµæ›´ç©©",
            "3) å†æŠŠæŠ•è³‡è®Šæˆç¿’æ…£ï¼šç”¨å®šæœŸå®šé¡å›ºå®šæ¨é€²"
          ],
          close:"ã€ç›´æ¥è¦åŠƒã€Œå®Œæ•´åˆ°ä½ç‰ˆã€ï¼Œæœªä¾†å°±ä¸ç”¨æ“”å¿ƒã€‚æ¯å€‹æœˆçš„å¯è² æ“”çš„é ç®—å®Œæˆè¦åŠƒã€‚ã€"
        }
      },
      family: {
        A: {
          steps:[
            "1) å…ˆè£œè²¬ä»»ç¼ºå£ï¼šå…ˆæŠŠã€æ‹–ç´¯å®¶äººã€çš„é¢¨éšªé™åˆ°æœ€ä½",
            "2) å†è£œé†«ç™‚è‡ªè²»ç¼ºå£ï¼šé¿å…é•·æœŸæ²»ç™‚æ‹–å®å®¶åº­ç¾é‡‘æµ",
            "3) é å‚™é‡‘æ…¢æ…¢æ‹‰ï¼šå…ˆå¾ 1â€“3 å€‹æœˆé–‹å§‹"
          ],
          close:"ã€é‡é»åœ¨æ„çš„æ˜¯å®¶äººï¼Œå…ˆè£œã€Œè²¬ä»»ç¼ºå£ã€ï¼Œåœ¨é ç®—å…§å®Œæˆä¿éšœè¦åŠƒã€"
        },
        B: {
          steps:[
            "1) è²¬ä»»ä¿éšœï¼‹é‡å¤§é¢¨éšªä¸€æ¬¡åˆ°ä½ï¼šæŠŠå®¶åº­æœ€æ€•çš„ç¼ºå£è£œé½Š",
            "2) é†«ç™‚èˆ‡æ„å¤–æ•´ç†å®Œæ•´ï¼šé™ä½é•·æœŸèŠ±è²»è¡æ“Š",
            "3) é å‚™é‡‘æ‹‰åˆ° 3â€“6 å€‹æœˆï¼šå®¶åº­å®‰å…¨é‚Šéš›æ›´å¤§"
          ],
          close:"ã€æˆ‘å€‘ç›´æ¥åšã€Œå®Œæ•´åˆ°ä½ç‰ˆã€ï¼ŒæŠŠåœ¨æ„çš„ã€Œå®¶äººå®‰å…¨æ„Ÿã€ä¸€æ¬¡åšåˆ°ä½ã€‚ã€"
        }
      },
      future: {
        A: {
          steps:[
            "1) å…ˆç”¨é¢¨éšªç®¡ç†æŠŠè¨ˆç•«ä¿ä½ï¼šé†«ç™‚/æ„å¤–å…ˆåšåŸºæœ¬é˜²è­·",
            "2) æ¯æœˆå›ºå®šä¸€ç­†åšã€è¨ˆç•«åŸºé‡‘ã€ï¼šå…ˆæŠŠç›®æ¨™åšå‡ºä¾†",
            "3) æŠ•è³‡ç­‰ç¾é‡‘æµç©©å†åŠ ï¼šé¿å…ä¸­é€”è¢«è¿«åœæ‰"
          ],
          close:"ã€é‡é»æ˜¯è¨ˆç•«ï¼Œå…ˆåšã€Œä½è² æ“”ç‰ˆã€æŠŠè¨ˆç•«ä¿ä½ï¼Œå†ç”¨å›ºå®šé‡‘é¡åšè¨ˆç•«åŸºé‡‘ã€‚ã€"
        },
        B: {
          steps:[
            "1) é¢¨éšªç®¡ç†å®Œæ•´åŒ–ï¼šè®“è¨ˆç•«ä¸æœƒè¢«ä¸€æ¬¡äº‹ä»¶æ‰“æ–·",
            "2) è¨ˆç•«åŸºé‡‘ï¼‹æŠ•è³‡ç¿’æ…£ä¸€èµ·å»ºç«‹ï¼šç”¨åˆ¶åº¦æŠŠç›®æ¨™æ¨é€²",
            "3) é å‚™é‡‘æ‹‰åˆ° 3â€“6 å€‹æœˆï¼šè®“è¨ˆç•«æ›´ä¸æ€•æ³¢å‹•"
          ],
          close:"ã€æœ€åœ¨æ„çš„æ˜¯è¨ˆç•«ï¼Œå…ˆåšã€Œå®Œæ•´åˆ°ä½ç‰ˆã€ï¼ŒæŠŠã€Œå­˜ä¸€æ¡¶é‡‘ï¼‹é¢¨éšªä¿è­·å‚˜ã€éƒ½å®Œæˆã€‚ã€"
        }
      }
    };

    const s = (scripts[currentFocus] && scripts[currentFocus][currentDeal]) || scripts.life.A;

    const lines = [
      ...base,
      "ä¸‹ä¸€æ­¥å»ºè­°ï¼ˆä¾ä½ é¸çš„å„ªå…ˆé †åºï¼‰ï¼š",
      ...s.steps,
      "",
      s.close
    ];

    document.getElementById("nextStep").innerText = lines.join("\n");
  }

  function renderDealCard(){
    const dealBox=document.getElementById("dealBox");
    const dealPill=document.getElementById("dealPill");
    const dealScript=document.getElementById("dealScript");

    // small card script = last close line + one-liner
    const oneLiner = `ä»Šå¤©å…ˆåšï¼š${focusLabel(currentFocus)}ï¼ˆ${dealLabel(currentDeal)}ï¼‰`;
    const closeLine = document.getElementById("nextStep").innerText.split("\n").slice(-1)[0] || "";

    dealPill.innerText = `ç‰ˆæœ¬ï¼š${dealLabel(currentDeal)}ï½œé‡è¦–ï¼š${focusLabel(currentFocus)}`;
    dealScript.innerText = `${oneLiner}\n\n${closeLine}`;
    dealBox.style.display="block";
  }

  function analyze(){
    updatePreviewAndReport();

    const finance = scoreFinance();
    const protection = scoreProtection();
    const emergency = scoreEmergencyFund();

    if(chart) chart.destroy();
    chart=new Chart(document.getElementById("triangleChart"),{
      type:"radar",
      data:{
        labels:["ç†è²¡","ä¿éšœ","ç·Šæ€¥é å‚™é‡‘"],
        datasets:[{
          data:[finance, protection, emergency],
          backgroundColor:"rgba(31,111,255,0.2)",
          borderColor:"#1f6fff",
          borderWidth:2
        }]
      },
      options:{
        maintainAspectRatio:false,
        plugins:{legend:{display:false}},
        scales:{r:{min:0,max:3,ticks:{display:false}}}
      }
    });

    // Summary
    const summaryEl=document.getElementById("summary");
    const exp=getExpenseTotal();
    const income=getMonthlyIncome();
    const remain=income-exp;
    const fm=getFundMonths();
    const st=fundStatus(fm);
    const prot=scoreProtection();

    if(remain<=0){
      summaryEl.innerText="ç¾é‡‘æµç›®å‰åç·Šï¼Œå»ºè­°å…ˆæŠŠæ”¯å‡ºçµæ§‹èˆ‡ä¿è²»è² æ“”æ•´ç†æ¸…æ¥šï¼Œå†è«‡æŠ•è³‡èˆ‡é•·æœŸè¦åŠƒã€‚";
    }else if(st.level==="bad"){
      summaryEl.innerText="é å‚™é‡‘ä¸è¶³ï¼šå…ˆæŠŠç·Šæ€¥é å‚™é‡‘æ‹‰èµ·ä¾†ï¼Œé¿å…ä¸€å€‹äº‹ä»¶å°±è®“ç¾é‡‘æµå¤±æ§ã€‚";
    }else if(prot===1){
      summaryEl.innerText="ä¿éšœåå°‘ï¼šå…ˆæŠŠåŸºæœ¬ä¿éšœè£œèµ·ä¾†ï¼Œè®“çªç™¼äº‹ä»¶ä¸æœƒæ‰“æ–·ç”Ÿæ´»èˆ‡è¨ˆç•«ã€‚";
    }else{
      summaryEl.innerText="ä½ çš„çµæ§‹æœ‰åŸºç¤ï¼šå¯ä»¥ç”¨ã€Œä¿ä½é¢¨éšªï¼‹æ‹‰èµ·é å‚™é‡‘ï¼‹å»ºç«‹ç†è²¡ç¿’æ…£ã€ä¸‰æ­¥é©Ÿç©©å®šæ¨é€²ã€‚";
    }

    // Generate suggestion with currentFocus/currentDeal
    renderNextStep();

    // Clear focus & deal card until chosen
    document.getElementById("focusResult").innerText="";
    document.getElementById("focusTalk").innerText="";
    document.getElementById("dealBox").style.display="none";
    document.getElementById("dealPill").innerText="ç‰ˆæœ¬ï¼šâ€”";
    document.getElementById("dealScript").innerText="";
  }

  // ---------- Modals ----------
  function openFocus(){ document.getElementById("focusModal").style.display="block"; }
  function closeFocus(){ document.getElementById("focusModal").style.display="none"; }

  function openDeal(){ document.getElementById("dealModal").style.display="block"; }
  function closeDeal(){ document.getElementById("dealModal").style.display="none"; }

  function chooseFocus(type){
    currentFocus = type;

    const focusText = focusExplain(type);
    document.getElementById("focusTalk").innerText = focusText;
    document.getElementById("focusResult").innerText = focusText;

    // Also refresh next steps immediately
    renderNextStep();
  }

  function chooseDeal(deal){
    currentDeal = deal;
    renderNextStep();
    renderDealCard();
  }

  // ---------- PDF ----------
  async function downloadPDF(){
    const summaryText=(document.getElementById("summary").innerText||"").trim();
    if(!summaryText){
      alert("è«‹å…ˆæŒ‰ã€Œåˆ†ææˆ‘çš„ç†è²¡é‡‘ä¸‰è§’ã€ç”¢ç”Ÿå ±å‘Šå…§å®¹ï¼Œå†ä¸‹è¼‰ PDFã€‚");
      return;
    }

    updatePreviewAndReport();

    // Ensure deal card shows if user already selected
    if(document.getElementById("dealBox").style.display==="none"){
      // show minimal card if they didn't click
      renderNextStep();
    }

    // Replace radar canvas with image to avoid missing in PDF
    const canvas=document.getElementById("triangleChart");
    const dataUrl=canvas.toDataURL("image/png",1.0);
    const img=document.createElement("img");
    img.src=dataUrl;
    img.style.width="100%";
    img.style.maxWidth="360px";
    img.style.display="block";
    img.style.margin="0 auto";

    const wrapper=canvas.parentElement;
    const backup=canvas.style.display;
    canvas.style.display="none";
    wrapper.appendChild(img);

    await new Promise(r=>requestAnimationFrame(r));

    const reportEl=document.getElementById("report");
    const canvasShot = await html2canvas(reportEl, {
      scale: 2,
      backgroundColor: "#ffffff",
      useCORS: true,
      scrollY: -window.scrollY
    });

    // restore
    img.remove();
    canvas.style.display=backup||"block";

    const imgData = canvasShot.toDataURL("image/jpeg", 0.95);
    const { jsPDF } = window.jspdf;

    const pdf = new jsPDF("p","mm","a4");
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();

    const imgWidth = pageWidth;
    const imgHeight = canvasShot.height * imgWidth / canvasShot.width;

    let heightLeft = imgHeight;
    let position = 0;

    pdf.addImage(imgData,"JPEG",0,position,imgWidth,imgHeight);
    heightLeft -= pageHeight;

    while(heightLeft > 0){
      position = heightLeft - imgHeight;
      pdf.addPage();
      pdf.addImage(imgData,"JPEG",0,position,imgWidth,imgHeight);
      heightLeft -= pageHeight;
    }

    const alias=(document.getElementById("clientAlias").value||"").trim();
    const filenameBase=alias?`ç†è²¡é‡‘ä¸‰è§’_æˆäº¤ç‰ˆå ±å‘Š_${alias}`:"ç†è²¡é‡‘ä¸‰è§’_æˆäº¤ç‰ˆå ±å‘Š";
    pdf.save(`${filenameBase}.pdf`);
  }

  // ---------- Reset ----------
  function resetAll(){
    document.getElementById("clientAlias").value="";
    document.getElementById("clientAge").value="";

    document.getElementById("incomeType").value="month";
    document.getElementById("incomeAmount").value="";

    document.getElementById("housingType").value="rent";
    document.getElementById("housingNote").value="";

    ["exp_housing","exp_carloan","exp_utilities","exp_food","exp_transport","exp_kids","exp_lifestyle","exp_other"].forEach(id=>{
      document.getElementById(id).value="";
    });

    document.getElementById("insuranceMonthly").value="";
    document.getElementById("insuranceNote").value="";

    document.getElementById("emergencyFund").value="";
    document.getElementById("planText").value="";
    document.getElementById("planAmount").value="";
    document.getElementById("planYears").value="0";

    document.getElementById("investmentMonthly").value="";
    document.getElementById("investmentMethods").value="";
    document.getElementById("insuranceStatus").value="none";

    document.getElementById("summary").innerText="";
    document.getElementById("focusResult").innerText="";
    document.getElementById("focusTalk").innerText="";
    document.getElementById("nextStep").innerText="";

    document.getElementById("dealBox").style.display="none";
    document.getElementById("dealPill").innerText="ç‰ˆæœ¬ï¼šâ€”";
    document.getElementById("dealScript").innerText="";

    currentFocus="life";
    currentDeal="A";
    closeFocus();
    closeDeal();

    if(chart){ chart.destroy(); chart=null; }

    document.getElementById("incomeLabel").innerText="æœˆæ”¶å…¥";
    document.getElementById("reportDate").innerText=todayString();
    updatePreviewAndReport();
    document.getElementById("incomeAmount").focus();
  }

  // ---------- Wire up ----------
  document.addEventListener("DOMContentLoaded",()=>{
    document.getElementById("reportDate").innerText=todayString();

    const incomeTypeEl=document.getElementById("incomeType");
    const incomeLabelEl=document.getElementById("incomeLabel");
    function syncIncomeLabel(){
      incomeLabelEl.innerText=incomeTypeEl.value==="year"?"å¹´æ”¶å…¥":"æœˆæ”¶å…¥";
      updatePreviewAndReport();
    }
    incomeTypeEl.addEventListener("change",syncIncomeLabel);

    const watchIds=[
      "clientAlias","clientAge","incomeAmount","housingType","housingNote",
      "exp_housing","exp_carloan","exp_utilities","exp_food","exp_transport","exp_kids","exp_lifestyle","exp_other",
      "insuranceMonthly","insuranceNote",
      "emergencyFund","planText","planAmount","planYears",
      "investmentMonthly","investmentMethods","insuranceStatus"
    ];
    watchIds.forEach(id=>{
      const el=document.getElementById(id);
      if(!el) return;
      el.addEventListener(el.tagName==="SELECT" ? "change" : "input", updatePreviewAndReport);
    });

    document.getElementById("btnAnalyze").addEventListener("click",analyze);

    document.getElementById("btnOpenFocus").addEventListener("click",()=>{
      const summaryText=(document.getElementById("summary").innerText||"").trim();
      if(!summaryText){
        alert("è«‹å…ˆæŒ‰ã€Œåˆ†ææˆ‘çš„ç†è²¡é‡‘ä¸‰è§’ã€ç”¢ç”Ÿå ±å‘Šå…§å®¹ï¼Œå†é€²å…¥æˆäº¤æµç¨‹ã€‚");
        return;
      }
      openFocus();
    });

    document.getElementById("btnToDeal").addEventListener("click",()=>{
      // require focus chosen at least once: if no talk text, default to life
      if(!document.getElementById("focusTalk").innerText.trim()){
        chooseFocus("life");
      }
      closeFocus();
      openDeal();
    });

    document.getElementById("btnCloseFocus").addEventListener("click",closeFocus);

    document.querySelectorAll("#focusModal .option-btn[data-focus]").forEach(btn=>{
      btn.addEventListener("click",()=>chooseFocus(btn.dataset.focus));
    });

    document.querySelectorAll("#dealModal .option-btn[data-deal]").forEach(btn=>{
      btn.addEventListener("click",()=>chooseDeal(btn.dataset.deal));
    });

    document.getElementById("btnCloseDeal").addEventListener("click",()=>{
      closeDeal();
      // Ensure suggestion + deal card present
      renderNextStep();
      renderDealCard();
    });

    document.getElementById("btnPDF").addEventListener("click",downloadPDF);
    document.getElementById("btnReset").addEventListener("click",resetAll);

    syncIncomeLabel();
    updatePreviewAndReport();
    renderNextStep();
  });
</script>
</body>
</html>
